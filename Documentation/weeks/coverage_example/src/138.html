<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>p:\stuff\projects\minigamesproject\minigamesproject\assets\_assets\scripts\games\tankgame\tanknetworking.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using BeardedManStudios.Forge.Networking;
using BeardedManStudios.Forge.Networking.Generated;
using System;
using System.Collections;
using System.Collections.Generic;
using UnityEngine;

public class TankNetworking : TankNetworkingBehavior {

    #region fields
    private Player owner;

    private int health;
    private int tankScore;
    private Vector2 movement;

    private float rotation;
    private int fire;
    private int powerup;

    public TankPlayer.PlayerState State { get; private set; }
    public Player Owner { get =&gt; owner; }
    public int Health { get =&gt; health; set =&gt; health = value; }
    public int TankScore { get =&gt; tankScore; set =&gt; tankScore = value; }
    public Vector2 Movement { get =&gt; movement; set =&gt; movement = value; }
    public float Rotation { get =&gt; rotation; set =&gt; rotation = value; }
    public int Fire { get =&gt; fire; set =&gt; fire = value; }
    public int Powerup { get =&gt; powerup; set =&gt; powerup = value; }

    private Vector2 Test() { return movement; }
    #endregion

    private void Awake() {
        State = TankPlayer.PlayerState.Disabled;
    }
    protected override void NetworkStart() {
        base.NetworkStart();

        networkObject.UpdateInterval = 31;

        if (!networkObject.IsServer &amp;&amp; !networkObject.IsOwner) {
            return;
        }

        if (networkObject.IsServer) {
            GetComponent&lt;TankController&gt;().enabled = true;
        }

        if (networkObject.IsOwner || Player.MyPlayer().Local) {
            SetOwner(Player.MyPlayer(), false);
        }

        GetComponent&lt;TankPlayer&gt;().enabled = true;
        GetComponent&lt;TankControls&gt;().enabled = true;
        GetComponent&lt;TankWeapon&gt;().enabled = true;
    }

    private void Update() {

        if (networkObject == null || Owner == null) {
            return;
        }

        UpdateFields();
    }

    public void UpdateFields() {

        if (networkObject.IsServer) {
            if (Owner.Local || Owner.AI) {
                ServerOwnerFieldUpdate();
            } else {
                ServerFieldUpdate();
            }
        } else if (networkObject.IsOwner) {
            OwnerFieldUpdate();
        } else {
            ClientFieldUpdate();
        }
    }
    private void ServerOwnerFieldUpdate() {
        networkObject.Health = health;
        networkObject.Score = tankScore;

        networkObject.Movement = movement;
        networkObject.Rotation = rotation;
        networkObject.Fire = fire;
        networkObject.Powerup = powerup;
    }
    private void ServerFieldUpdate() {
        networkObject.Health = health;
        networkObject.Score = tankScore;

        movement = networkObject.Movement;
        rotation = networkObject.Rotation;
        fire = networkObject.Fire;
        powerup = networkObject.Powerup;
    }
    private void OwnerFieldUpdate() {
        networkObject.Movement = movement;
        networkObject.Rotation = rotation;
        networkObject.Fire = fire;
        networkObject.Powerup = powerup;

        health = networkObject.Health;
        tankScore = networkObject.Score;
    }

    private void ClientFieldUpdate() {

        // Necessary?
        health = networkObject.Health;
        tankScore = networkObject.Score;
    }

    #region RPCs
    public void ChangeState(TankPlayer.PlayerState state) {
        State = state;
        networkObject.SendRpc(RPC_CHANGE_STATE_R_P_C, Receivers.All, (byte)state);
    }
    public override void ChangeStateRPC(RpcArgs args) {
        byte stateByte = args.GetNext&lt;byte&gt;();
        State = (TankPlayer.PlayerState)stateByte;
    }

    public void SetOwner(Player player, bool force) {

        if (networkObject == null) {
            print(&quot;Setting owner before net init&quot;);
        }
        if (player == null) {
            Debug.LogError(&quot;given player was null&quot;);
        }

        print(&quot;SetOwner: &quot; + player.Name + &quot;, &quot; + force + &quot;, &quot; + player.Color);

        networkObject.SendRpc(RPC_SET_OWNER_R_P_C, Receivers.All, player.ID, force);
    }
    public override void SetOwnerRPC(RpcArgs args) {

        print(&quot;OWNER RPC -----------------------&quot;);

        int id = args.GetNext&lt;int&gt;();
        bool force = args.GetNext&lt;bool&gt;();

        if (owner != null &amp;&amp; !force) {
            print(&quot;Owner not set&quot;);
            return;
        }

        owner = Player.PlayerByID(id);

        print(&quot;Owner set to &quot; + owner.Name);

        if (networkObject.IsServer) {
            print(&quot;Setting color to &quot; + owner.Color);
            GetComponent&lt;TankController&gt;().SetMaterial();
        }
    }
    #endregion
    public static GameObject MyTank() {

        Player myPlayer = Player.MyPlayer();

        foreach (GameObject o in GameObject.FindGameObjectsWithTag(&quot;Player&quot;)) {

            TankNetworking n = o.GetComponent&lt;TankNetworking&gt;();
            if (n.Owner == null) {
                continue;
            }

            if (Player.Matches(n.Owner, myPlayer)) {
                return o;
            }
        }

        return null;
    }
    public static void MyTank(Action&lt;TankControls&gt; callback) {

        IEnumerator SearchCoroutine() {
            GameObject tank;

            float time = 10;

            while (true) {
                yield return null;

                time -= Time.deltaTime;

                tank = MyTank();

                if (tank != null) {
                    break;
                }

                if (time &lt; 0) {
                    print(&quot;Tank not found&quot;);
                    yield break;
                }
            }

            print(&quot;Tank found: &quot; + tank.name);
            callback(tank.GetComponent&lt;TankControls&gt;());
        }

        Scripts.RunCoroutine(SearchCoroutine());
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[21,43,21,47,0],[21,48,21,60,0],[22,34,22,39,0],[23,32,23,38,0],[23,47,23,61,0],[24,35,24,44,0],[24,53,24,70,0],[25,38,25,46,0],[25,55,25,71,0],[26,36,26,44,0],[26,53,26,69,0],[27,30,27,34,0],[27,43,27,55,0],[28,33,28,40,0],[28,49,28,64,0],[30,28,30,29,0],[30,30,30,46,0],[30,47,30,48,0],[33,26,33,27,0],[34,9,34,49,0],[35,5,35,6,0],[36,44,36,45,0],[37,9,37,29,0],[39,9,39,43,0],[41,9,41,63,0],[41,64,41,65,0],[42,13,42,20,0],[45,9,45,36,0],[45,37,45,38,0],[46,13,46,59,0],[47,9,47,10,0],[49,9,49,62,0],[49,63,49,64,0],[50,13,50,48,0],[51,9,51,10,0],[53,9,53,51,0],[54,9,54,53,0],[55,9,55,51,0],[56,5,56,6,0],[58,27,58,28,0],[60,9,60,52,0],[60,53,60,54,0],[61,13,61,20,0],[64,9,64,24,0],[65,5,65,6,0],[67,32,67,33,0],[69,9,69,36,0],[69,37,69,38,0],[70,13,70,41,0],[70,42,70,43,0],[71,17,71,42,0],[72,13,72,14,0],[72,20,72,21,0],[73,17,73,37,0],[74,13,74,14,0],[75,9,75,10,0],[75,16,75,42,0],[75,43,75,44,0],[76,13,76,32,0],[77,9,77,10,0],[77,16,77,17,0],[78,13,78,33,0],[79,9,79,10,0],[80,5,80,6,0],[81,43,81,44,0],[82,9,82,39,0],[83,9,83,41,0],[85,9,85,43,0],[86,9,86,43,0],[87,9,87,35,0],[88,9,88,41,0],[89,5,89,6,0],[90,38,90,39,0],[91,9,91,39,0],[92,9,92,41,0],[94,9,94,43,0],[95,9,95,43,0],[96,9,96,35,0],[97,9,97,41,0],[98,5,98,6,0],[99,37,99,38,0],[100,9,100,43,0],[101,9,101,43,0],[102,9,102,35,0],[103,9,103,41,0],[105,9,105,39,0],[106,9,106,41,0],[107,5,107,6,0],[109,38,109,39,0],[112,9,112,39,0],[113,9,113,41,0],[114,5,114,6,0],[117,59,117,60,0],[118,9,118,23,0],[119,9,119,83,0],[120,5,120,6,0],[121,55,121,56,0],[122,9,122,47,0],[123,9,123,51,0],[124,5,124,6,0],[126,53,126,54,0],[128,9,128,35,0],[128,36,128,37,0],[129,13,129,52,0],[130,9,130,10,0],[131,9,131,28,0],[131,29,131,30,0],[132,13,132,53,0],[133,9,133,10,0],[135,9,135,80,0],[137,9,137,85,0],[138,5,138,6,0],[139,52,139,53,0],[141,9,141,52,0],[143,9,143,38,0],[144,9,144,43,0],[146,9,146,37,0],[146,38,146,39,0],[147,13,147,36,0],[148,13,148,20,0],[151,9,151,39,0],[153,9,153,45,0],[155,9,155,36,0],[155,37,155,38,0],[156,13,156,54,0],[157,13,157,58,0],[158,9,158,10,0],[159,5,159,6,0],[161,39,161,40,0],[163,9,163,45,0],[165,9,165,16,0],[165,18,165,30,0],[165,31,165,33,0],[165,34,165,77,0],[165,79,165,80,0],[167,13,167,65,0],[168,13,168,33,0],[168,34,168,35,0],[169,17,169,26,0],[172,13,172,51,0],[172,52,172,53,0],[173,17,173,26,0],[175,9,175,10,0],[177,9,177,21,0],[178,5,178,6,0],[179,62,179,63,0],[181,39,181,40,0],[184,13,184,29,0],[186,13,186,25,0],[186,26,186,27,0],[187,17,187,35,0],[189,17,189,40,0],[191,17,191,33,0],[193,17,193,34,0],[193,35,193,36,0],[194,21,194,27,0],[197,17,197,30,0],[197,31,197,32,0],[198,21,198,45,0],[199,21,199,33,0],[201,13,201,14,0],[203,13,203,47,0],[204,13,204,57,0],[205,9,205,10,0],[207,9,207,49,0],[208,5,208,6,0]]);
    </script>
  </body>
</html>