<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>p:\stuff\projects\minigamesproject\minigamesproject\assets\_assets\scripts\bearded man studios\scripts\multiplayer menu\multiplayermenu.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using BeardedManStudios.Forge.Networking;
using BeardedManStudios.Forge.Networking.Unity;
using BeardedManStudios.Forge.Networking.Lobby;
using BeardedManStudios.SimpleJSON;
using System.Collections.Generic;
using UnityEngine;
using UnityEngine.SceneManagement;
using UnityEngine.UI;

public class MultiplayerMenu : MonoBehaviour {
    public InputField ipAddress = null;
    public InputField portNumber = null;
    public bool DontChangeSceneOnConnect = false;
    public string masterServerHost = string.Empty;
    public ushort masterServerPort = 15940;
    public string natServerHost = string.Empty;
    public ushort natServerPort = 15941;
    public bool connectUsingMatchmaking = false;
    public bool useElo = false;
    public int myElo = 0;
    public int eloRequired = 0;

    public GameObject networkManager = null;
    public GameObject[] ToggledButtons;
    private NetworkManager mgr = null;
    private NetWorker server;

    private List&lt;Button&gt; _uiButtons = new List&lt;Button&gt;();
    private bool _matchmaking = false;
    public bool useMainThreadManagerForRPCs = true;
    public bool useInlineChat = false;

    public bool getLocalNetworkConnections = false;

    public bool useTCP = false;

    private void Start() {
        ipAddress.text = &quot;127.0.0.1&quot;;
        portNumber.text = &quot;15937&quot;;

        for (int i = 0; i &lt; ToggledButtons.Length; ++i) {
            Button btn = ToggledButtons[i].GetComponent&lt;Button&gt;();
            if (btn != null)
                _uiButtons.Add(btn);
        }

        if (!useTCP) {
            // Do any firewall opening requests on the operating system
            NetWorker.PingForFirewall(ushort.Parse(portNumber.text));
        }

        if (useMainThreadManagerForRPCs)
            Rpc.MainThreadRunner = MainThreadManager.Instance;

        if (getLocalNetworkConnections) {
            NetWorker.localServerLocated += LocalServerLocated;
            NetWorker.RefreshLocalUdpListings(ushort.Parse(portNumber.text));
        }
    }

    private void LocalServerLocated(NetWorker.BroadcastEndpoints endpoint, NetWorker sender) {
        Debug.Log(&quot;Found endpoint: &quot; + endpoint.Address + &quot;:&quot; + endpoint.Port);
    }

    public void Connect() {

        print(&quot;BMS CONNECT&quot;);

        if (connectUsingMatchmaking) {
            ConnectToMatchmaking();
            return;
        }
        ushort port;
        if (!ushort.TryParse(portNumber.text, out port)) {
            Debug.LogError(&quot;The supplied port number is not within the allowed range 0-&quot; + ushort.MaxValue);
            return;
        }

        NetWorker client;

        if (useTCP) {
            client = new TCPClient();
            print(&quot;Joining: &quot; + ipAddress.text + &quot;:&quot; + port);
            ((TCPClient)client).Connect(ipAddress.text, (ushort)port);
        } else {
            client = new UDPClient();
            if (natServerHost.Trim().Length == 0)
                ((UDPClient)client).Connect(ipAddress.text, (ushort)port);
            else
                ((UDPClient)client).Connect(ipAddress.text, (ushort)port, natServerHost, natServerPort);
        }

        Connected(client);
    }

    public void ConnectToMatchmaking() {
        if (_matchmaking)
            return;

        SetToggledButtons(false);
        _matchmaking = true;

        if (mgr == null &amp;&amp; networkManager == null)
            throw new System.Exception(&quot;A network manager was not provided, this is required for the tons of fancy stuff&quot;);

        mgr = Instantiate(networkManager).GetComponent&lt;NetworkManager&gt;();

        mgr.MatchmakingServersFromMasterServer(masterServerHost, masterServerPort, myElo, (response) =&gt; {
            _matchmaking = false;
            SetToggledButtons(true);
            Debug.LogFormat(&quot;Matching Server(s) count[{0}]&quot;, response.serverResponse.Count);

            //TODO: YOUR OWN MATCHMAKING EXTRA LOGIC HERE!
            // I just make it randomly pick a server... you can do whatever you please!
            if (response != null &amp;&amp; response.serverResponse.Count &gt; 0) {
                MasterServerResponse.Server server = response.serverResponse[Random.Range(0, response.serverResponse.Count)];
                //TCPClient client = new TCPClient();
                UDPClient client = new UDPClient();
                client.Connect(server.Address, server.Port);
                Connected(client);
            }
        });
    }

    public void Host() {
        if (useTCP) {
            server = new TCPServer(64);
            ((TCPServer)server).Connect();
        } else {
            server = new UDPServer(64);

            if (natServerHost.Trim().Length == 0)
                ((UDPServer)server).Connect(ipAddress.text, ushort.Parse(portNumber.text));
            else
                ((UDPServer)server).Connect(port: ushort.Parse(portNumber.text), natHost: natServerHost, natPort: natServerPort);
        }

        server.playerTimeout += (player, sender) =&gt; {
            Debug.Log(&quot;Player &quot; + player.NetworkId + &quot; timed out&quot;);
        };
        //LobbyService.Instance.Initialize(server);

        Connected(server);
    }

    private void Update() {
        if (Input.GetKeyDown(KeyCode.H))
            Host();
        else if (Input.GetKeyDown(KeyCode.C))
            Connect();
        else if (Input.GetKeyDown(KeyCode.L)) {
            NetWorker.localServerLocated -= TestLocalServerFind;
            NetWorker.localServerLocated += TestLocalServerFind;
            NetWorker.RefreshLocalUdpListings();
        }
    }

    private void TestLocalServerFind(NetWorker.BroadcastEndpoints endpoint, NetWorker sender) {
        Debug.Log(&quot;Address: &quot; + endpoint.Address + &quot;, Port: &quot; + endpoint.Port + &quot;, Server? &quot; + endpoint.IsServer);
    }

    public void Connected(NetWorker networker) {
        if (!networker.IsBound) {
            Debug.LogError(&quot;NetWorker failed to bind&quot;);
            return;
        }

        if (mgr == null &amp;&amp; networkManager == null) {
            Debug.LogWarning(&quot;A network manager was not provided, generating a new one instead&quot;);
            networkManager = new GameObject(&quot;Network Manager&quot;);
            mgr = networkManager.AddComponent&lt;NetworkManager&gt;();
        } else if (mgr == null)
            mgr = Instantiate(networkManager).GetComponent&lt;NetworkManager&gt;();

        // If we are using the master server we need to get the registration data
        JSONNode masterServerData = null;
        if (!string.IsNullOrEmpty(masterServerHost)) {
            string serverId = &quot;myGame&quot;;
            string serverName = &quot;Forge Game&quot;;
            string type = &quot;Deathmatch&quot;;
            string mode = &quot;Teams&quot;;
            string comment = &quot;Demo comment...&quot;;

            masterServerData = mgr.MasterServerRegisterData(networker, serverId, serverName, type, mode, comment, useElo, eloRequired);
        }

        mgr.Initialize(networker, masterServerHost, masterServerPort, masterServerData);

        if (networker is IServer) {
            if (!DontChangeSceneOnConnect)
                SceneManager.LoadScene(SceneManager.GetActiveScene().buildIndex + 1);
            else
                NetworkObject.Flush(networker); //Called because we are already in the correct scene!
        }
    }

    private void CreateInlineChat(Scene arg0, LoadSceneMode arg1) {
        SceneManager.sceneLoaded -= CreateInlineChat;
        var chat = NetworkManager.Instance.InstantiateChatManager();
        DontDestroyOnLoad(chat.gameObject);
    }

    private void SetToggledButtons(bool value) {
        for (int i = 0; i &lt; _uiButtons.Count; ++i)
            _uiButtons[i].interactable = value;
    }

    private void OnApplicationQuit() {
        if (getLocalNetworkConnections)
            NetWorker.EndSession();

        if (server != null)
            server.Disconnect(true);
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[11,5,11,40,0],[12,5,12,41,0],[13,5,13,50,0],[14,5,14,51,0],[15,5,15,44,0],[16,5,16,48,0],[17,5,17,41,0],[18,5,18,49,0],[19,5,19,32,0],[20,5,20,26,0],[21,5,21,32,0],[23,5,23,45,0],[25,5,25,39,0],[28,5,28,58,0],[29,5,29,39,0],[30,5,30,52,0],[31,5,31,39,0],[33,5,33,52,0],[35,5,35,32,0],[37,26,37,27,0],[38,9,38,38,0],[39,9,39,35,0],[41,14,41,23,0],[41,25,41,50,0],[41,52,41,55,0],[41,57,41,58,0],[42,13,42,67,0],[43,13,43,29,0],[44,17,44,37,0],[45,9,45,10,0],[47,9,47,21,0],[47,22,47,23,0],[49,13,49,70,0],[50,9,50,10,0],[52,9,52,41,0],[53,13,53,63,0],[55,9,55,40,0],[55,41,55,42,0],[56,13,56,64,0],[57,13,57,78,0],[58,9,58,10,0],[59,5,59,6,0],[61,94,61,95,0],[62,9,62,80,0],[63,5,63,6,0],[65,27,65,28,0],[67,9,67,30,0],[69,9,69,37,0],[69,38,69,39,0],[70,13,70,36,0],[71,13,71,20,0],[74,9,74,57,0],[74,58,74,59,0],[75,13,75,109,0],[76,13,76,20,0],[81,9,81,20,0],[81,21,81,22,0],[82,13,82,38,0],[83,13,83,62,0],[84,13,84,71,0],[85,9,85,10,0],[85,16,85,17,0],[86,13,86,38,0],[87,13,87,50,0],[88,17,88,75,0],[90,17,90,105,0],[91,9,91,10,0],[93,9,93,27,0],[94,5,94,6,0],[96,40,96,41,0],[97,9,97,26,0],[98,13,98,20,0],[100,9,100,34,0],[101,9,101,29,0],[103,9,103,51,0],[104,13,104,124,0],[106,9,106,74,0],[108,9,108,105,0],[108,105,108,106,0],[108,106,109,13,0],[109,13,109,34,0],[109,34,110,13,0],[110,13,110,37,0],[110,37,111,13,0],[111,13,111,93,0],[111,93,115,13,0],[115,13,115,71,0],[115,71,115,72,0],[115,72,115,73,0],[115,73,116,17,0],[116,17,116,126,0],[116,126,118,17,0],[118,17,118,52,0],[118,52,119,17,0],[119,17,119,61,0],[119,61,120,17,0],[120,17,120,35,0],[120,35,121,13,0],[121,13,121,14,0],[121,14,122,9,0],[122,9,122,10,0],[122,10,122,12,0],[108,9,122,12,0],[123,5,123,6,0],[125,24,125,25,0],[126,9,126,20,0],[126,21,126,22,0],[127,13,127,40,0],[128,13,128,43,0],[129,9,129,10,0],[129,16,129,17,0],[130,13,130,40,0],[132,13,132,50,0],[133,17,133,92,0],[135,17,135,130,0],[136,9,136,10,0],[138,9,138,53,0],[138,53,138,54,0],[138,54,139,13,0],[139,13,139,68,0],[139,68,140,9,0],[140,9,140,10,0],[140,10,140,11,0],[138,9,140,11,0],[143,9,143,27,0],[144,5,144,6,0],[146,27,146,28,0],[147,9,147,41,0],[148,13,148,20,0],[149,14,149,46,0],[150,13,150,23,0],[151,14,151,46,0],[151,47,151,48,0],[152,13,152,65,0],[153,13,153,65,0],[154,13,154,49,0],[155,9,155,10,0],[156,5,156,6,0],[158,95,158,96,0],[159,9,159,115,0],[160,5,160,6,0],[162,48,162,49,0],[163,9,163,32,0],[163,33,163,34,0],[164,13,164,56,0],[165,13,165,20,0],[168,9,168,51,0],[168,52,168,53,0],[169,13,169,98,0],[170,13,170,64,0],[171,13,171,65,0],[172,9,172,10,0],[172,16,172,32,0],[173,13,173,78,0],[176,9,176,42,0],[177,9,177,53,0],[177,54,177,55,0],[178,13,178,40,0],[179,13,179,46,0],[180,13,180,40,0],[181,13,181,35,0],[182,13,182,48,0],[184,13,184,136,0],[185,9,185,10,0],[187,9,187,89,0],[189,9,189,34,0],[189,35,189,36,0],[190,13,190,43,0],[191,17,191,86,0],[193,17,193,48,0],[194,9,194,10,0],[195,5,195,6,0],[197,67,197,68,0],[198,9,198,54,0],[199,9,199,69,0],[200,9,200,44,0],[201,5,201,6,0],[203,48,203,49,0],[204,14,204,23,0],[204,25,204,45,0],[204,47,204,50,0],[205,13,205,48,0],[206,5,206,6,0],[208,38,208,39,0],[209,9,209,40,0],[210,13,210,36,0],[212,9,212,28,0],[213,13,213,37,0],[214,5,214,6,0]]);
    </script>
  </body>
</html>