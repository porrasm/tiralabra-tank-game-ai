<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>p:\stuff\projects\minigamesproject\minigamesproject\assets\_assets\scripts\games\tankgame\tanklevelgenerator.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections;
using System.Collections.Generic;
using System.Diagnostics;
using UnityEngine;

// Most things breaks if width != height, fix later :):)
public class TankLevelGenerator : MonoBehaviour {

    #region fields
    private TankMazeGenerator generator;
    private List&lt;Step&gt; steps;
    private TankCell[,] cells;
    private Vector2 area;

    private int width;
    private int height;

    [SerializeField]
    private GameObject cellPrefab;

    [SerializeField]
    private Transform cellParent, levelFloor;

    private Transform levelParent;

    public bool Building { get; set; }

    private byte[,] level;

    public byte[,] Level { get =&gt; level; private set =&gt; level = value; }

    public struct Step {
        public IntCoords Coords;
        public TankCell.CellWall Wall;
        public bool Silent;
        public override string ToString() {
            return Wall + &quot; &quot; + Coords;
        }
    }

    #endregion

    #region Basic
    private void Awake() {

        if (Instance == null) {
            Instance = this;
        } else {
            UnityEngine.Debug.LogError(&quot;Instance is already set.&quot;);
            Destroy(this);
        }

        generator = new TankMazeGenerator();
    }
    private void Start() {   
        levelParent = GameObject.FindGameObjectWithTag(&quot;Level&quot;).transform;
    }
    private void Update() {
        if (Input.GetKeyDown(KeyCode.R)) {
            GenerateLevel();
            BuildGeneratedLevel();
        }
    }

    public void GenerateLevel() {
        generator.GenerateMaze(out steps, out level);
    }
    public void BuildGeneratedLevel() {

        if (Building) {
            return;
        }

        Initialize();

        Building = true;

        BuildLevel();
    }

    #endregion

    #region Initialization
    private void Initialize() {
        ClearLevel();
        InitializeVariables();
        InitializeLevel();
    }

    private void InitializeVariables() {

        width = TankSettings.LevelWidth;
        height = TankSettings.LevelHeight;

        cells = new TankCell[width, height];
    }
    private void ClearLevel() {
        foreach (Transform child in cellParent) {
            Destroy(child.gameObject);
        }
    }

    private void InitializeLevel() {
        InitializeLevelArea();
        InitializeCamera();
        SetSpawns();
        CreateCells();
    }

    private void InitializeLevelArea() {
        levelFloor.localScale = new Vector3(0.1f * height, 1, 0.1f * width);
        levelFloor.position = new Vector3(0.5f * width, levelFloor.position.y, 0.5f * height);
    }
    private void InitializeCamera() {

        Vector3 position = new Vector3(1.0f * height / 2, 10, 1.0f * width / 2);
        float size;

        if (height &gt; width) {
            size = position.x * TankSettings.CameraSizeFactorX;
        } else {
            size = position.z * TankSettings.CameraSizeFactorY;
        }

        Camera.main.transform.position = position;
        Camera.main.orthographicSize = size;
    }

    private void SetSpawns() {

        Transform spawns = GameObject.FindGameObjectWithTag(&quot;Respawn&quot;).transform;

        for (int i = 0; i &lt; spawns.childCount; i++) {
            spawns.GetChild(i).position = SpawnPosition(i);
            spawns.GetChild(i).LookAt(new Vector3(0.5f * width, 0, 0.5f * height));
        }
    }
    private Vector3 SpawnPosition(int index) {

        float offset = 0.5f;

        switch (index) {
            case 0:
                return new Vector3(offset, 0, offset);
            case 1:
                return new Vector3(width - offset, 0, height - offset);
            case 2:
                return new Vector3(offset, 0, height - offset);
            case 3:
                return new Vector3(width - offset, 0, offset);
            case 4:
                return new Vector3(offset * width, 0, offset);
            case 5:
                return new Vector3(offset * width, 0, height - offset);
            case 6:
                return new Vector3(width - offset, 0, offset * height);
            case 7:
                return new Vector3(offset, 0, offset * height);
        }

        return Vector3.zero;
    }

    private void CreateCells() {
        for (int x = 0; x &lt; width; x++) {
            for (int y = 0; y &lt; height; y++) {
                CreateCell(x, y);
            }
        }
    }
    private void CreateCell(int x, int y) {

        GameObject newCell = Instantiate(cellPrefab);

        newCell.name = &quot;Cell (&quot; + x + &quot;, &quot; + y + &quot; )&quot;;

        cells[x, y] = newCell.GetComponent&lt;TankCell&gt;();
        cells[x, y].SetWalls(TankSettings.StartActive);

        Transform t = newCell.transform;

        t.SetParent(cellParent);
        t.localScale = new Vector3(1, 1, 1);
        t.localPosition = CellPosition(x, y);
    }
    private Vector3 CellPosition(int x, int y) {
        return new Vector3(x, 0, y);
    }
    #endregion
   
    #region Building
    private void BuildLevel() {
        StartCoroutine(BuildCoroutine());
    }
    private IEnumerator BuildCoroutine() {

        float waitTime = TankSettings.GenerateTime / steps.Count;

        Stopwatch watch = new Stopwatch();

        float additional = 0;

        foreach (Step step in steps) {

            if (ProcessStep(step)) {
                continue;
            }

            if (waitTime == 0) {
                continue;
            } else if (waitTime + additional &lt; Time.deltaTime) {
                additional += Time.deltaTime;
                continue;
            }

            yield return new WaitForSeconds(waitTime + additional);
            additional = 0;
        }

        Building = false;
    }
    private bool ProcessStep(Step step) {

        TankCell cell = cells[step.Coords.x, step.Coords.y];

        if (cell == null) {
            return true;
        }

        cell.SetWalls(true);
        cell.DisableWall(step.Wall);

        return step.Silent;
    }
    #endregion

    public static TankLevelGenerator Instance { get; private set; }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[27,28,27,32,0],[27,33,27,37,0],[31,42,31,47,0],[31,64,31,77,0],[37,43,37,44,0],[38,13,38,40,0],[39,9,39,10,0],[45,26,45,27,0],[46,9,46,45,0],[47,5,47,6,0],[48,26,48,27,0],[49,9,49,75,0],[50,5,50,6,0],[51,27,51,28,0],[52,9,52,41,0],[52,42,52,43,0],[53,13,53,29,0],[54,13,54,35,0],[55,9,55,10,0],[56,5,56,6,0],[58,33,58,34,0],[59,9,59,54,0],[60,5,60,6,0],[61,39,61,40,0],[63,9,63,22,0],[63,23,63,24,0],[64,13,64,20,0],[67,9,67,22,0],[69,9,69,25,0],[71,9,71,22,0],[72,5,72,6,0],[77,31,77,32,0],[78,9,78,22,0],[79,9,79,31,0],[80,9,80,27,0],[81,5,81,6,0],[83,40,83,41,0],[85,9,85,41,0],[86,9,86,43,0],[88,9,88,45,0],[89,5,89,6,0],[90,31,90,32,0],[91,9,91,16,0],[91,18,91,33,0],[91,34,91,36,0],[91,37,91,47,0],[91,49,91,50,0],[92,13,92,39,0],[93,9,93,10,0],[94,5,94,6,0],[96,36,96,37,0],[97,9,97,31,0],[98,9,98,28,0],[99,9,99,21,0],[100,9,100,23,0],[101,5,101,6,0],[103,40,103,41,0],[104,9,104,77,0],[105,9,105,95,0],[106,5,106,6,0],[107,37,107,38,0],[109,9,109,81,0],[112,9,112,28,0],[112,29,112,30,0],[113,13,113,64,0],[114,9,114,10,0],[114,16,114,17,0],[115,13,115,64,0],[116,9,116,10,0],[118,9,118,51,0],[119,9,119,45,0],[120,5,120,6,0],[122,30,122,31,0],[124,9,124,82,0],[126,14,126,23,0],[126,25,126,46,0],[126,48,126,51,0],[126,53,126,54,0],[127,13,127,60,0],[128,13,128,84,0],[129,9,129,10,0],[130,5,130,6,0],[131,46,131,47,0],[133,9,133,29,0],[135,9,135,23,0],[137,17,137,55,0],[139,17,139,72,0],[141,17,141,64,0],[143,17,143,63,0],[145,17,145,63,0],[147,17,147,72,0],[149,17,149,72,0],[151,17,151,64,0],[154,9,154,29,0],[155,5,155,6,0],[157,32,157,33,0],[158,14,158,23,0],[158,25,158,34,0],[158,36,158,39,0],[158,41,158,42,0],[159,18,159,27,0],[159,29,159,39,0],[159,41,159,44,0],[159,46,159,47,0],[160,17,160,34,0],[161,13,161,14,0],[162,9,162,10,0],[163,5,163,6,0],[164,43,164,44,0],[166,9,166,54,0],[168,9,168,55,0],[170,9,170,56,0],[171,9,171,56,0],[173,9,173,41,0],[175,9,175,33,0],[176,9,176,45,0],[177,9,177,46,0],[178,5,178,6,0],[179,48,179,49,0],[180,9,180,37,0],[181,5,181,6,0],[185,31,185,32,0],[186,9,186,42,0],[187,5,187,6,0],[188,42,188,43,0],[190,9,190,66,0],[192,9,192,43,0],[194,9,194,30,0],[196,9,196,16,0],[196,18,196,27,0],[196,28,196,30,0],[196,31,196,36,0],[196,38,196,39,0],[198,13,198,35,0],[198,36,198,37,0],[199,17,199,26,0],[202,13,202,31,0],[202,32,202,33,0],[203,17,203,26,0],[204,20,204,63,0],[204,64,204,65,0],[205,17,205,46,0],[206,17,206,26,0],[209,13,209,68,0],[210,13,210,28,0],[211,9,211,10,0],[213,9,213,26,0],[214,5,214,6,0],[215,41,215,42,0],[217,9,217,61,0],[219,9,219,26,0],[219,27,219,28,0],[220,13,220,25,0],[223,9,223,29,0],[224,9,224,37,0],[226,9,226,28,0],[227,5,227,6,0]]);
    </script>
  </body>
</html>