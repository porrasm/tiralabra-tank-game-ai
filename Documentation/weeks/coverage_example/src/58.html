<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>p:\stuff\projects\minigamesproject\minigamesproject\assets\_assets\scripts\bearded man studios\scripts\networking\buffermanager.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using BeardedManStudios.Concurrency;
using System;
using System.Collections.Generic;
using System.Threading;

namespace BeardedManStudios
{
    public class BufferManager
    {
        public readonly int bufferSize;
        public readonly int bufferPageSize;
        public readonly int maxBufferPages;
        private readonly object @lock = new object();

        public long MaxBufferPoolSize { get { return bufferSize * (long)bufferPageSize * maxBufferPages; } }

        private readonly ConcurrentQueue&lt;ArraySegment&lt;byte&gt;&gt; POOLED_BUFFERS = new ConcurrentQueue&lt;ArraySegment&lt;byte&gt;&gt;();
        private readonly byte[][] PAGES;

        public BufferManager(int buffersSize = 4096, int bufferPageSize = 256, int maxBufferPages = 128)
        {
            if (buffersSize &lt; 1 || bufferPageSize &lt; 1 || maxBufferPages &lt; 1)
                throw new ArgumentOutOfRangeException(&quot;Arguments must be positive.&quot;);
            this.bufferSize = buffersSize;
            this.bufferPageSize = bufferPageSize;
            this.maxBufferPages = maxBufferPages;
            PAGES = new byte[maxBufferPages][];
            AddPage();
        }

        private int BinarySearchForFirstNull(Array array, int start, int end)
        {
            // No match
            if (start == end)
                return -1;

            int midpoint = (end + start) / 2;

            // Not null, so no match
            if (array.GetValue(midpoint) != null)
                return BinarySearchForFirstNull(array, midpoint + 1, end);

            // Match
            if ((midpoint == 0) || (array.GetValue(midpoint - 1) != null))
                return midpoint;

            // Not first null, so no match
            return BinarySearchForFirstNull(array, start, midpoint);
        }

        private bool AddPage()
        {

            lock (@lock)
            {
                if (POOLED_BUFFERS.Count &gt; 0)
                {
                    return true;
                }
                int index = BinarySearchForFirstNull(PAGES, 0, PAGES.Length);
                if (index &lt; 0)
                    return false; // PAGES is full
                PAGES[index] = new byte[bufferSize * bufferPageSize];
                for (int i = 0; i &lt; bufferPageSize; i++)
                    POOLED_BUFFERS.Enqueue(new ArraySegment&lt;byte&gt;(PAGES[index], i * bufferSize, bufferSize));
            }
            
            return true;
        }

        public bool TryTakeBuffer(out ArraySegment&lt;byte&gt; buffer)
        {
            do
            {
                if (POOLED_BUFFERS.TryDequeue(out buffer))
                    return true;
            } while (AddPage());

            return false;
        }

        public void ReturnBuffer(ArraySegment&lt;byte&gt; buffer)
        {
            POOLED_BUFFERS.Enqueue(buffer);
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[13,9,13,54,0],[15,45,15,46,0],[15,47,15,105,0],[15,106,15,107,0],[17,9,17,121,0],[20,9,20,105,0],[21,9,21,10,0],[22,13,22,77,0],[23,17,23,86,0],[24,13,24,43,0],[25,13,25,50,0],[26,13,26,50,0],[27,13,27,48,0],[28,13,28,23,0],[29,9,29,10,0],[32,9,32,10,0],[34,13,34,30,0],[35,17,35,27,0],[37,13,37,46,0],[40,13,40,50,0],[41,17,41,75,0],[44,13,44,75,0],[45,17,45,33,0],[48,13,48,69,0],[49,9,49,10,0],[52,9,52,10,0],[54,13,54,25,0],[55,13,55,14,0],[56,17,56,46,0],[57,17,57,18,0],[58,21,58,33,0],[60,17,60,78,0],[61,17,61,31,0],[62,21,62,34,0],[63,17,63,70,0],[64,22,64,31,0],[64,33,64,51,0],[64,53,64,56,0],[65,21,65,110,0],[66,13,66,14,0],[68,13,68,25,0],[69,9,69,10,0],[72,9,72,10,0],[74,13,74,14,0],[75,17,75,59,0],[76,21,76,33,0],[77,13,77,14,0],[77,15,77,33,0],[79,13,79,26,0],[80,9,80,10,0],[83,9,83,10,0],[84,13,84,44,0],[85,9,85,10,0]]);
    </script>
  </body>
</html>