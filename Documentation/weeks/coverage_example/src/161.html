<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>p:\stuff\projects\minigamesproject\minigamesproject\assets\_assets\scripts\games\tankgame\tankbullet.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System.Collections;
using System.Collections.Generic;
using UnityEngine;

public class TankBullet : MonoBehaviour {

    #region fields
    public TankPlayer Owner { get; set; }
    public int Bounces { get =&gt; bounces; set =&gt; bounces = value; }
    public float AliveTime { get =&gt; aliveTime; set =&gt; aliveTime = value; }
    public bool ConstantDamage { get; set; }
    public int Damage { get =&gt; damage; set =&gt; damage = value; }
    public Vector3 Velocity { get =&gt; velocity; set =&gt; velocity = value; }

    protected int damage;
    protected float speed;

    protected Rigidbody rb;
    private Vector3 velocity;

    protected float harmlessTime = 0.3f;
    protected float aliveTime;
    protected int bounces;

    protected int collisionFrames;
    #endregion


    private void Awake() {
        transform.position = transform.position += transform.forward * speed * Time.deltaTime;
    }
    private void Start() {

        Damage = TankSettings.BulletDamage;
        speed = TankSettings.BulletSpeed;
        rb = GetComponent&lt;Rigidbody&gt;();

        Velocity = transform.forward * speed;

        AliveTime = TankSettings.BulletAliveTime;
        Bounces = TankSettings.BulletBounces;

        print(&quot;Calling event&quot;);
        TankEvents.Instance.CallEvent(TankEvents.EventType.BulletEvent);
    }

    public void SetDirection(Vector3 direction) {
        direction.y = 0;
        Velocity = direction.normalized * speed;
    }

    private void Update() {
        UpdateTime();
        FixVelocity();
    }
    private void UpdateTime() {

        if (AliveTime &gt; 0) {
            AliveTime -= Time.deltaTime;
        } else {
            Kill();
        }

        if (harmlessTime &gt; 0) {
            harmlessTime -= Time.deltaTime;
        }
    }
    private void FixVelocity() {
        rb.velocity = Velocity;
        rb.angularVelocity = Vector3.zero;
    }

    #region Collision
    protected void OnCollisionEnter(Collision collision) {
        collisionFrames = 0;
        CollisionHappened(collision, false);
        TankEvents.Instance.CallEvent(TankEvents.EventType.BulletEvent);
    }
    protected void OnCollisionStay(Collision collision) {
        collisionFrames++;
        if (collisionFrames &gt; 2) {
            FixCollision(collision);
        }
    }
    protected void OnCollisionExit(Collision collision) {
        collisionFrames = 0;
    }
    protected virtual void FixCollision(Collision collision) {
        if (collisionFrames &gt; 6) {
            Vector3 rnd = new Vector3(Random.value, 0, Random.value);
            collisionFrames = 0;
            SetDirection(rnd);
        } else {
            CollisionHappened(collision, true);
        }
    }
    protected virtual void CollisionHappened(Collision collision, bool fix) {
        if (HitPlayer(collision.gameObject)) {
            return;
        }

        if (Bounces == 0) {
            Kill();
        }

        Bounce(collision.contacts[0].normal);

        if (!ConstantDamage) {
            Damage -= TankSettings.BulletDamageBounceReduction;
        }

        if (!fix) {
            Bounces--;
        }
    }
    public void Bounce(Vector3 normal) {
        Vector3 newDirection = Vector3.Reflect(Velocity, normal);
        Velocity = newDirection.normalized * speed;
    }

    protected void Kill() {
        Destroy(gameObject);
    }

    protected bool HitPlayer(GameObject obj) {

        TankPlayer p = obj.GetComponent&lt;TankPlayer&gt;();

        if (p == null) {
            return false;
        }

        if (harmlessTime &gt; 0) {
            if (p.Equals(Owner)) {
                return true;
            }
        }

        p.DoDamage(Damage, Owner);
        Kill();
        return true;
    }
    #endregion
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[8,31,8,35,0],[8,36,8,40,0],[9,33,9,40,0],[9,49,9,64,0],[10,37,10,46,0],[10,55,10,72,0],[11,34,11,38,0],[11,39,11,43,0],[12,32,12,38,0],[12,47,12,61,0],[13,38,13,46,0],[13,55,13,71,0],[21,5,21,41,0],[29,26,29,27,0],[30,9,30,95,0],[31,5,31,6,0],[32,26,32,27,0],[34,9,34,44,0],[35,9,35,42,0],[36,9,36,40,0],[38,9,38,46,0],[40,9,40,50,0],[41,9,41,46,0],[43,9,43,32,0],[44,9,44,73,0],[45,5,45,6,0],[47,49,47,50,0],[48,9,48,25,0],[49,9,49,49,0],[50,5,50,6,0],[52,27,52,28,0],[53,9,53,22,0],[54,9,54,23,0],[55,5,55,6,0],[56,31,56,32,0],[58,9,58,27,0],[58,28,58,29,0],[59,13,59,41,0],[60,9,60,10,0],[60,16,60,17,0],[61,13,61,20,0],[62,9,62,10,0],[64,9,64,30,0],[64,31,64,32,0],[65,13,65,44,0],[66,9,66,10,0],[67,5,67,6,0],[68,32,68,33,0],[69,9,69,32,0],[70,9,70,43,0],[71,5,71,6,0],[74,58,74,59,0],[75,9,75,29,0],[76,9,76,45,0],[77,9,77,73,0],[78,5,78,6,0],[79,57,79,58,0],[80,9,80,27,0],[81,9,81,33,0],[81,34,81,35,0],[82,13,82,37,0],[83,9,83,10,0],[84,5,84,6,0],[85,57,85,58,0],[86,9,86,29,0],[87,5,87,6,0],[88,62,88,63,0],[89,9,89,33,0],[89,34,89,35,0],[90,13,90,70,0],[91,13,91,33,0],[92,13,92,31,0],[93,9,93,10,0],[93,16,93,17,0],[94,13,94,48,0],[95,9,95,10,0],[96,5,96,6,0],[97,77,97,78,0],[98,9,98,45,0],[98,46,98,47,0],[99,13,99,20,0],[102,9,102,26,0],[102,27,102,28,0],[103,13,103,20,0],[104,9,104,10,0],[106,9,106,46,0],[108,9,108,29,0],[108,30,108,31,0],[109,13,109,64,0],[110,9,110,10,0],[112,9,112,18,0],[112,19,112,20,0],[113,13,113,23,0],[114,9,114,10,0],[115,5,115,6,0],[116,40,116,41,0],[117,9,117,66,0],[118,9,118,52,0],[119,5,119,6,0],[121,27,121,28,0],[122,9,122,29,0],[123,5,123,6,0],[125,46,125,47,0],[127,9,127,55,0],[129,9,129,23,0],[129,24,129,25,0],[130,13,130,26,0],[133,9,133,30,0],[133,31,133,32,0],[134,13,134,33,0],[134,34,134,35,0],[135,17,135,29,0],[137,9,137,10,0],[139,9,139,35,0],[140,9,140,16,0],[141,9,141,21,0],[142,5,142,6,0]]);
    </script>
  </body>
</html>