<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>p:\stuff\projects\minigamesproject\minigamesproject\assets\_assets\scripts\games\tankgame\tankhealthbar.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System.Collections;
using System.Collections.Generic;
using UnityEngine;

public class TankHealthbar : MonoBehaviour {

    #region fields
    private Vector3 pos;

    private Material background, foreground;
    private Transform[] bars;

    private Transform tank;

    private TankNetworking net;

    private Vector3 defaultScale;

    private ColliderCallback colliderCallback;

    private int barColliderCount;

    private float targetTransparency = 0.3f;

    [SerializeField]
    private Color backgroundColor, foregroundColor;

    [SerializeField]
    private Color[] barColors;

    private float transparency;
    private enum TransparencyState { Transparent, Opaque, ToTransparent, ToOpaque }
    private TransparencyState state;
    #endregion


    void Start() {

        if (barColors.Length != 3) {
            barColors = new Color[3];
        }

        tank = transform.parent;
        net = tank.GetComponent&lt;TankNetworking&gt;();

        pos = transform.localPosition;

        bars = new Transform[3];

        bars[0] = transform.GetChild(0).GetChild(0);
        bars[1] = transform.GetChild(0).GetChild(1);
        bars[2] = transform.GetChild(0).GetChild(2);

        colliderCallback = transform.GetChild(1).gameObject.AddComponent&lt;ColliderCallback&gt;();
        colliderCallback.AddTriggerEnterCallback(BarEnter);
        colliderCallback.AddTriggerExitCallback(BarExit);

        background = transform.GetChild(2).GetComponent&lt;Renderer&gt;().material;
        foreground = transform.GetChild(3).GetComponent&lt;Renderer&gt;().material;

        defaultScale = bars[0].localScale;

        state = TransparencyState.Opaque;
        transparency = 1;
        SetTransparency();
        UpdateColors();
    }

    void Update() {
        UpdatePosition();
        UpdateBars();
        UpdateColors();
    }

    private void UpdatePosition() {
        transform.eulerAngles = Vector3.zero;
        transform.position = tank.position + pos;
    }

    private void UpdateBars() {

        int barIndex = net.Health / 100;

        if (barIndex &lt; 0) {
            return;
        }

        for (int i = 0; i &lt; barIndex; i++) {
            bars[i].localScale = defaultScale;
            Vector3 pos = bars[i].localPosition;
            pos.x = 0;
            bars[i].localPosition = pos;
        }
        for (int i = 2; i &gt; barIndex; i--) {
            bars[i].gameObject.SetActive(false);
        }

        if (barIndex &gt; 2 || barIndex &lt; 0) {
            return;
        }

        UpdateCurrentBar(barIndex);
    }
    private void UpdateCurrentBar(int i) {

        bars[i].gameObject.SetActive(true);

        int offsetHealth = net.Health % 100;

        float scaleFactor = 0.01f * offsetHealth;

        Vector3 scaleVector = bars[i].localScale;
        scaleVector.x = scaleFactor;

        bars[i].localScale = scaleVector;

        Vector3 posVector = bars[i].localPosition;
        posVector.x = -(1 - scaleFactor) * 0.5f;

        bars[i].localPosition = posVector;
    }

    private void SetToTransparent() {

        if (state == TransparencyState.Transparent || state == TransparencyState.ToTransparent) {
            return;
        }

        StopAllCoroutines();

        state = TransparencyState.ToTransparent;

        IEnumerator TCoroutine() {

            float distance = 1 - targetTransparency;
            float speed = distance / 1;

            while (transparency &gt; targetTransparency) {
                transparency -= speed * Time.deltaTime;
                SetTransparency();
                UpdateColors();

                yield return null;
            }

            transparency = targetTransparency;
            SetTransparency();
            UpdateColors();

            state = TransparencyState.Transparent;
        }

        StartCoroutine(TCoroutine());
    }
    private void SetToOpaque() {

        if (state == TransparencyState.Opaque || state == TransparencyState.ToOpaque) {
            return;
        }

        StopAllCoroutines();

        state = TransparencyState.ToOpaque;

        IEnumerator TCoroutine() {

            float distance = 1 - targetTransparency;
            float speed = distance / 1;

            while (transparency &lt; 1) {
                transparency += speed * Time.deltaTime;
                SetTransparency();
                UpdateColors();

                yield return null;
            }

            transparency = 1;
            SetTransparency();
            UpdateColors();

            state = TransparencyState.Opaque;
        }

        StartCoroutine(TCoroutine());
    }

    private void SetTransparency() {

        backgroundColor.a = transparency;
        foregroundColor.a = transparency;

        for (int i = 0; i &lt; 3; i++) {
            barColors[i].a = transparency;
        }
    }
    private void UpdateColors() {
        background.color = backgroundColor;
        foreground.color = foregroundColor;

        for (int i = 0; i &lt; 3; i++) {
            bars[i].GetComponent&lt;Renderer&gt;().material.color = barColors[i];
        }
    }

    private void BarEnter(GameObject obj, Collider collider) {

        if (collider.transform.parent != null &amp;&amp; collider.transform.parent.GetComponent&lt;TankPlayer&gt;() != null) {
            barColliderCount++;
            ChangeTransparency();
        }
    }
    private void BarExit(GameObject obj, Collider collider) {

        if (collider.transform.parent != null &amp;&amp; collider.transform.parent.GetComponent&lt;TankPlayer&gt;() != null) {
            barColliderCount--;
            ChangeTransparency();
        }
    }

    private void ChangeTransparency() {

        if (barColliderCount == 0 &amp;&amp; (state == TransparencyState.Transparent || state == TransparencyState.ToTransparent)) {
            SetToOpaque();
        }
        if (barColliderCount != 0 &amp;&amp; (state == TransparencyState.Opaque || state == TransparencyState.ToOpaque)) {
            SetToTransparent();
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[23,5,23,45,0],[37,18,37,19,0],[39,9,39,35,0],[39,36,39,37,0],[40,13,40,38,0],[41,9,41,10,0],[43,9,43,33,0],[44,9,44,51,0],[46,9,46,39,0],[48,9,48,33,0],[50,9,50,53,0],[51,9,51,53,0],[52,9,52,53,0],[54,9,54,94,0],[55,9,55,60,0],[56,9,56,58,0],[58,9,58,78,0],[59,9,59,78,0],[61,9,61,43,0],[63,9,63,42,0],[64,9,64,26,0],[65,9,65,27,0],[66,9,66,24,0],[67,5,67,6,0],[69,19,69,20,0],[70,9,70,26,0],[71,9,71,22,0],[72,9,72,24,0],[73,5,73,6,0],[75,35,75,36,0],[76,9,76,46,0],[77,9,77,50,0],[78,5,78,6,0],[80,31,80,32,0],[82,9,82,41,0],[84,9,84,26,0],[84,27,84,28,0],[85,13,85,20,0],[88,14,88,23,0],[88,25,88,37,0],[88,39,88,42,0],[88,44,88,45,0],[89,13,89,47,0],[90,13,90,49,0],[91,13,91,23,0],[92,13,92,41,0],[93,9,93,10,0],[94,14,94,23,0],[94,25,94,37,0],[94,39,94,42,0],[94,44,94,45,0],[95,13,95,49,0],[96,9,96,10,0],[98,9,98,42,0],[98,43,98,44,0],[99,13,99,20,0],[102,9,102,36,0],[103,5,103,6,0],[104,42,104,43,0],[106,9,106,44,0],[108,9,108,45,0],[110,9,110,50,0],[112,9,112,50,0],[113,9,113,37,0],[115,9,115,42,0],[117,9,117,51,0],[118,9,118,49,0],[120,9,120,43,0],[121,5,121,6,0],[123,37,123,38,0],[125,9,125,96,0],[125,97,125,98,0],[126,13,126,20,0],[129,9,129,29,0],[131,9,131,49,0],[133,34,133,35,0],[135,13,135,53,0],[136,13,136,40,0],[138,13,138,54,0],[138,55,138,56,0],[139,17,139,56,0],[140,17,140,35,0],[141,17,141,32,0],[143,17,143,35,0],[144,13,144,14,0],[146,13,146,47,0],[147,13,147,31,0],[148,13,148,28,0],[150,13,150,51,0],[151,9,151,10,0],[153,9,153,38,0],[154,5,154,6,0],[155,32,155,33,0],[157,9,157,86,0],[157,87,157,88,0],[158,13,158,20,0],[161,9,161,29,0],[163,9,163,44,0],[165,34,165,35,0],[167,13,167,53,0],[168,13,168,40,0],[170,13,170,37,0],[170,38,170,39,0],[171,17,171,56,0],[172,17,172,35,0],[173,17,173,32,0],[175,17,175,35,0],[176,13,176,14,0],[178,13,178,30,0],[179,13,179,31,0],[180,13,180,28,0],[182,13,182,46,0],[183,9,183,10,0],[185,9,185,38,0],[186,5,186,6,0],[188,36,188,37,0],[190,9,190,42,0],[191,9,191,42,0],[193,14,193,23,0],[193,25,193,30,0],[193,32,193,35,0],[193,37,193,38,0],[194,13,194,43,0],[195,9,195,10,0],[196,5,196,6,0],[197,33,197,34,0],[198,9,198,44,0],[199,9,199,44,0],[201,14,201,23,0],[201,25,201,30,0],[201,32,201,35,0],[201,37,201,38,0],[202,13,202,76,0],[203,9,203,10,0],[204,5,204,6,0],[206,62,206,63,0],[208,9,208,111,0],[208,112,208,113,0],[209,13,209,32,0],[210,13,210,34,0],[211,9,211,10,0],[212,5,212,6,0],[213,61,213,62,0],[215,9,215,111,0],[215,112,215,113,0],[216,13,216,32,0],[217,13,217,34,0],[218,9,218,10,0],[219,5,219,6,0],[221,39,221,40,0],[223,9,223,123,0],[223,124,223,125,0],[224,13,224,27,0],[225,9,225,10,0],[226,9,226,113,0],[226,114,226,115,0],[227,13,227,32,0],[228,9,228,10,0],[229,5,229,6,0]]);
    </script>
  </body>
</html>