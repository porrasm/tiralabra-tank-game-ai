<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>p:\stuff\projects\minigamesproject\minigamesproject\assets\_assets\scripts\networking\server.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
//Backup
using BeardedManStudios.Forge.Networking;
using BeardedManStudios.Forge.Networking.Unity;
using System.Net;
using System.Net.Sockets;
using UnityEngine;

public class Server {

    #region fields
    public const ushort PORT = 15937;
    public static string IP = &quot;127.0.0.1&quot;;

    public static string natServerHost = string.Empty;
    public static ushort natServerPort = 15938;

    private static NetworkManager manager;

    public static NetWorker Networker { get; private set; }

    public static bool useTCP = false;
    #endregion

    public static void Initialize() {
        Rpc.MainThreadRunner = MainThreadManager.Instance;

        if (!useTCP) {
            // Do any firewall opening requests on the operating system
            NetWorker.PingForFirewall(PORT);
        }
    }

    public static bool StartServer() {

        SetIP();

        if (useTCP) {
            Networker = new TCPServer(64);
            ((TCPServer)Networker).Connect(IP, PORT);
        } else {
            Networker = new UDPServer(64);

            if (natServerHost.Trim().Length == 0) {
                ((UDPServer)Networker).Connect(IP, PORT);
            } else {
                ((UDPServer)Networker).Connect(port: PORT, natHost: natServerHost, natPort: natServerPort);
            }
        }

        Networker.playerTimeout += PlayerTimeout;

        bool created = Connected(Networker);

        if (created) {
            Networker.playerAccepted += new NetWorker.PlayerEvent(OnPlayerJoin);
        }

        return created;
    }
    public static void SetIP() {
        var host = Dns.GetHostEntry(Dns.GetHostName());
        foreach (var ip in host.AddressList) {
            if (ip.AddressFamily == AddressFamily.InterNetwork) {
                IP = ip.ToString();
                return;
            }
        }
    }

    public static bool ConnectToServer() {

        //NetWorker.localServerLocated += LocalServerLocated;
        //NetWorker.RefreshLocalUdpListings(PORT);

        MonoBehaviour.print(&quot;Connecting to :&quot; + IP);

        return ConnectToAddress(IP, PORT);
    }

    private static bool ConnectToAddress(string IP, ushort PORT) {
        MonoBehaviour.print(&quot;Joining game&quot;);

        //
        if (useTCP) {
            Networker = new TCPClient();
            MonoBehaviour.print(&quot;Joining: &quot; + IP + &quot;:&quot; + PORT);
            ((TCPClient)Networker).Connect(IP, PORT);
        } else {
            Networker = new UDPClient();
            if (natServerHost.Trim().Length == 0) {
                ((UDPClient)Networker).Connect(IP, PORT);
            } else {
                ((UDPClient)Networker).Connect(IP, PORT, natServerHost, natServerPort);
            }
        }
        //

        bool connected = Connected(Networker);

        MonoBehaviour.print(&quot;Connected: &quot; + connected);
        MonoBehaviour.print(&quot;Client: &quot; + Networker);

        if (connected) {
            Networker.serverAccepted += new NetWorker.BaseNetworkEvent(OnServerConnect);
        }

        return connected;
    }

    private static bool Connected(NetWorker networker) {
        if (!networker.IsBound) {
            Debug.LogError(&quot;NetWorker failed to bind&quot;);
            return false;
        }

        GetManager();

        manager.Initialize(networker, &quot;&quot;, PORT, null);

        NetworkObject.Flush(networker);
        return true;
    }

    private static void GetManager() {

        GameObject old = GameObject.FindGameObjectWithTag(&quot;NetworkManager&quot;);

        if (old) {
            if (old.GetComponent&lt;NetworkManager&gt;()) {
                manager = old.GetComponent&lt;NetworkManager&gt;();
                return;
            }
            Debug.LogError(&quot;Network manager not found&quot;);
            MonoBehaviour.Destroy(old);
        }

        GameObject managerObject = new GameObject();
        managerObject.name = &quot;NetworkManager&quot;;
        managerObject.tag = &quot;NetworkManager&quot;;
        manager = managerObject.AddComponent&lt;NetworkManager&gt;();
    }

    #region events
    private static void OnPlayerJoin(NetworkingPlayer player, NetWorker sender) {
        MonoBehaviour.print(&quot;Player connected: &quot; + player.NetworkId);
    }
    private static void OnServerConnect(NetWorker sender) {
        MonoBehaviour.print(&quot;Joined server&quot;);
    }
    private static void PlayerTimeout(NetworkingPlayer player, NetWorker sender) {
        MonoBehaviour.print(&quot;Player &quot; + player.NetworkId + &quot; timed out&quot;);
    }
    #endregion
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[12,5,12,43,0],[14,5,14,55,0],[15,5,15,48,0],[19,41,19,45,0],[19,46,19,58,0],[21,5,21,39,0],[24,37,24,38,0],[25,9,25,59,0],[27,9,27,21,0],[27,22,27,23,0],[29,13,29,45,0],[30,9,30,10,0],[31,5,31,6,0],[33,38,33,39,0],[35,9,35,17,0],[37,9,37,20,0],[37,21,37,22,0],[38,13,38,43,0],[39,13,39,54,0],[40,9,40,10,0],[40,16,40,17,0],[41,13,41,43,0],[43,13,43,50,0],[43,51,43,52,0],[44,17,44,58,0],[45,13,45,14,0],[45,20,45,21,0],[46,17,46,108,0],[47,13,47,14,0],[48,9,48,10,0],[50,9,50,50,0],[52,9,52,45,0],[54,9,54,21,0],[54,22,54,23,0],[55,13,55,81,0],[56,9,56,10,0],[58,9,58,24,0],[59,5,59,6,0],[60,32,60,33,0],[61,9,61,56,0],[62,9,62,16,0],[62,18,62,24,0],[62,25,62,27,0],[62,28,62,44,0],[62,46,62,47,0],[63,13,63,64,0],[63,65,63,66,0],[64,17,64,36,0],[65,17,65,24,0],[67,9,67,10,0],[68,5,68,6,0],[70,42,70,43,0],[75,9,75,53,0],[77,9,77,43,0],[78,5,78,6,0],[80,66,80,67,0],[81,9,81,45,0],[84,9,84,20,0],[84,21,84,22,0],[85,13,85,41,0],[86,13,86,64,0],[87,13,87,54,0],[88,9,88,10,0],[88,16,88,17,0],[89,13,89,41,0],[90,13,90,50,0],[90,51,90,52,0],[91,17,91,58,0],[92,13,92,14,0],[92,20,92,21,0],[93,17,93,88,0],[94,13,94,14,0],[95,9,95,10,0],[98,9,98,47,0],[100,9,100,56,0],[101,9,101,53,0],[103,9,103,23,0],[103,24,103,25,0],[104,13,104,89,0],[105,9,105,10,0],[107,9,107,26,0],[108,5,108,6,0],[110,56,110,57,0],[111,9,111,32,0],[111,33,111,34,0],[112,13,112,56,0],[113,13,113,26,0],[116,9,116,22,0],[118,9,118,55,0],[120,9,120,40,0],[121,9,121,21,0],[122,5,122,6,0],[124,38,124,39,0],[126,9,126,77,0],[128,9,128,17,0],[128,18,128,19,0],[129,13,129,52,0],[129,53,129,54,0],[130,17,130,62,0],[131,17,131,24,0],[133,13,133,57,0],[134,13,134,40,0],[135,9,135,10,0],[137,9,137,53,0],[138,9,138,47,0],[139,9,139,46,0],[140,9,140,64,0],[141,5,141,6,0],[144,81,144,82,0],[145,9,145,70,0],[146,5,146,6,0],[147,59,147,60,0],[148,9,148,46,0],[149,5,149,6,0],[150,82,150,83,0],[151,9,151,74,0],[152,5,152,6,0]]);
    </script>
  </body>
</html>