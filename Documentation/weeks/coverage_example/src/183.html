<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>p:\stuff\projects\minigamesproject\minigamesproject\assets\_assets\scripts\games\tankgame\tankmazegenerator.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System.Collections;
using System.Collections.Generic;
using UnityEngine;

public class TankMazeGenerator {

    #region fields
    private List&lt;TankLevelGenerator.Step&gt; steps;
    private byte[,] level;
    private bool[,] visited;

    private System.Random rnd;
    private int width;
    private int height;
    #endregion

    public TankMazeGenerator() {
        rnd = new System.Random();
    }

    public void LevelFromSteps(out byte[,] oLevel, List&lt;TankLevelGenerator.Step&gt; levelSteps) {

        // oLevel = null;

        InitializeVariables();
        steps = levelSteps;
        SetLevelArray();

        oLevel = level;

        NullifyVariables();
    }
    public void GenerateMaze(out List&lt;TankLevelGenerator.Step&gt; oSteps, out byte[,] oLevel) {

        InitializeVariables();
        Generate();

        SetLevelArray();

        oSteps = steps;
        oLevel = level;

        NullifyVariables();
    }

    private void Generate() {
        DFSGenerateMaze();
        CleanLevel();   
    }

    private void InitializeVariables() {

        width = TankSettings.LevelWidth;
        height = TankSettings.LevelHeight;

        visited = new bool[width, height];

        steps = new List&lt;TankLevelGenerator.Step&gt;();
        level = new byte[width, height];
    }
    private void NullifyVariables() {
        steps = null;
        level = null;
        visited = null;
    }

    private void AddStep(int x, int y, TankCell.CellWall wall, bool silent) {
        TankLevelGenerator.Step step = new TankLevelGenerator.Step() { Coords = new IntCoords(x, y), Wall = wall, Silent = silent };
        steps.Add(step);
    }

    #region Generation
    private void DFSGenerateMaze() {
        visited[0, 0] = true;
        DFSGenerateMazeRecursive(new IntCoords(), StartDirection());
    }
    private TankDirection StartDirection() {
        if (rnd.Next(2) == 0) {
            return TankDirection.Right;
        }

        return TankDirection.Up;
    }

    private void DFSGenerateMazeRecursive(IntCoords coords, TankDirection direction) {

        IntCoords newCoords = coords.MoveToDirection(direction);

        if (InvalidIntCoords(newCoords)) {
            return;
        }

        DFSMove(newCoords, direction);

        foreach (TankDirection dir in RandomDirection()) {
            DFSGenerateMazeRecursive(newCoords, dir);
        }
    }

    private void DFSMove(IntCoords coords, TankDirection direction) {

        TankLevelGenerator.Step step = new TankLevelGenerator.Step();

        visited[coords.x, coords.y] = true;

        if (direction == TankDirection.Up) {

            step.Coords = coords.MoveToDirection(TankDirection.Down);
            step.Wall = TankCell.CellWall.Top;

        } else if (direction == TankDirection.Right) {

            step.Coords = coords.MoveToDirection(TankDirection.Left);
            step.Wall = TankCell.CellWall.Right;

        } else if (direction == TankDirection.Down) {

            step.Coords = coords;
            step.Wall = TankCell.CellWall.Top;

        } else if (direction == TankDirection.Left) {

            step.Coords = coords;
            step.Wall = TankCell.CellWall.Right;
        }

        steps.Add(step);
    }

    private bool InvalidIntCoords(IntCoords coords) {

        if (coords.x &lt; 0 || coords.x &gt;= width) {
            return true;
        }
        if (coords.y &lt; 0 || coords.y &gt;= height) {
            return true;
        }

        return visited[coords.x, coords.y];
    }

    private TankDirection[] RandomDirection() {

        TankDirection[] dir = new TankDirection[4];

        List&lt;TankDirection&gt; order = new List&lt;TankDirection&gt;();
        order.Add(TankDirection.Up);
        order.Add(TankDirection.Right);
        order.Add(TankDirection.Down);
        order.Add(TankDirection.Left);

        for (int i = 0; i &lt; 4; i++) {
            int dirIndex = rnd.Next(order.Count);
            dir[i] = order[dirIndex];
            order.RemoveAt(dirIndex);
        }

        return dir;
    }
    #endregion

    #region Cleaning
    private void CleanLevel() {
        RemoveEdgeWalls();
        CleanSpawns();
        ThinLevel();
    }

    private void RemoveEdgeWalls() {
        for (int x = 0; x &lt; width; x++) {
            AddStep(x, height - 1, TankCell.CellWall.Top, true);
        }
        for (int y = 0; y &lt; height; y++) {
            AddStep(width - 1, y, TankCell.CellWall.Right, true);
        }
    }

    private void CleanSpawns() {

        int cleanW = width - 2;
        int cleanH = height - 2;
        int cleanWHalf = width / 2 - 1;
        int cleanHHalf = height / 2 - 1;

        CleanArea(0, 0);
        CleanArea(cleanW, cleanH);
        CleanArea(cleanW, 0);
        CleanArea(0, cleanH);

        CleanArea(cleanWHalf, 0);
        CleanArea(cleanWHalf, cleanH);
        CleanArea(0, cleanHHalf);
        CleanArea(cleanW, cleanHHalf);
    }
    private void CleanArea(int x, int y) {
        for (int i = 0; i &lt; 1; i++) {
            for (int j = 0; j &lt; 1; j++) {
                AddStep(x + i, y + j, TankCell.CellWall.Both, false);
            }
        }
    }


    private void ThinLevel() {

        for (int i = 0; i &lt; width; i++) {

            int amount = rnd.Next(0, 4) + 2;
            bool deleting = RNG.Float &gt; TankSettings.CleanProbability;
            int n = 2;

            for (int j = 0; j &lt; height; j++) {

                if (deleting) {

                    AddStep(i, j, TankCell.CellWall.Both, false);

                    n++;
                    if (n &gt;= amount) {
                        deleting = false;
                    }
                } else if (RNG.Float &gt; TankSettings.CleanProbability) {
                    AddStep(i, j, TankCell.CellWall.Both, false);
                    deleting = true;
                }
            }
        }
    }
    #endregion

    #region LevelField
    private void SetLevelArray() {
        SetBasicDirections();
        SetAdvancedDirections();
    }

    private void SetBasicDirections() {

        foreach (TankLevelGenerator.Step step in steps) {

            if (step.Wall == TankCell.CellWall.Top || step.Wall == TankCell.CellWall.Both) {
                LinkDirection(step.Coords.x, step.Coords.y, TankDirection.Up);
            }
            if (step.Wall == TankCell.CellWall.Right || step.Wall == TankCell.CellWall.Both) {
                LinkDirection(step.Coords.x, step.Coords.y, TankDirection.Right);
            }
        }
    }

    private void SetAdvancedDirections() {

        for (int x = 0; x &lt; width; x++) {
            for (int y = 0; y &lt; height; y++) {

                byte b = level[x, y];

                if (TankDirectionTools.AllowedDirection(b, TankDirection.Up) &amp;&amp; TankDirectionTools.AllowedDirection(b, TankDirection.Right)) {

                    IntCoords moved = new IntCoords(x, y).MoveToDirection(TankDirection.UpRight);
                    byte b2 = level[moved.x, moved.y];

                    if (TankDirectionTools.AllowedDirection(b2, TankDirection.Down) &amp;&amp; TankDirectionTools.AllowedDirection(b2, TankDirection.Left)) {
                        LinkDirection(x, y, TankDirection.UpRight);
                    }
                }

                if (TankDirectionTools.AllowedDirection(b, TankDirection.Down) &amp;&amp; TankDirectionTools.AllowedDirection(b, TankDirection.Right)) {

                    IntCoords moved = new IntCoords(x, y).MoveToDirection(TankDirection.DownRight);
                    byte b2 = level[moved.x, moved.y];

                    if (TankDirectionTools.AllowedDirection(b2, TankDirection.Up) &amp;&amp; TankDirectionTools.AllowedDirection(b2, TankDirection.Left)) {
                        LinkDirection(x, y, TankDirection.DownRight);
                    }
                }
            }
        }
    }

    private void LinkDirection(int x, int y, TankDirection direction) {

        int newX = x;
        int newY = y;
        TankDirection newDirection = direction;

        IncrementAndSwitch(ref newX, ref newY, ref newDirection);

        if (!PossibleCoords(x, y) || !PossibleCoords(newX, newY)) {
            return;
        }

        TankDirectionTools.SetDirectionBit(ref level[x, y], direction);
        TankDirectionTools.SetDirectionBit(ref level[newX, newY], newDirection);
    }
    private void IncrementAndSwitch(ref int x, ref int y, ref TankDirection direction) {

        switch (direction) {
            case TankDirection.Up:
                y++;
                direction = TankDirection.Down;
                break;
            case TankDirection.Right:
                x++;
                direction = TankDirection.Left;
                break;
            case TankDirection.Down:
                y--;
                direction = TankDirection.Up;
                break;
            case TankDirection.Left:
                x--;
                direction = TankDirection.Right;
                break;
            case TankDirection.UpRight:
                x++;
                y++;
                direction = TankDirection.DownLeft;
                break;
            case TankDirection.DownRight:
                x++;
                y--;
                direction = TankDirection.UpLeft;
                break;
            case TankDirection.DownLeft:
                x--;
                y--;
                direction = TankDirection.UpRight;
                break;
            case TankDirection.UpLeft:
                x--;
                y++;
                direction = TankDirection.DownRight;
                break;
        }
    }


    private bool PossibleCoords(int x, int y) {
        if (x &lt; 0 || x &gt;= width) {
            return false;
        }
        if (y &lt; 0 || y &gt;= height) {
            return false;
        }

        return true;
    }
    #endregion
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[17,5,17,31,1],[17,32,17,33,1],[18,9,18,35,1],[19,5,19,6,1],[21,94,21,95,0],[25,9,25,31,0],[26,9,26,28,0],[27,9,27,25,0],[29,9,29,24,0],[31,9,31,28,0],[32,5,32,6,0],[33,92,33,93,1],[35,9,35,31,1],[36,9,36,20,1],[38,9,38,25,1],[40,9,40,24,1],[41,9,41,24,1],[43,9,43,28,1],[44,5,44,6,1],[46,29,46,30,1],[47,9,47,27,1],[48,9,48,22,1],[49,5,49,6,1],[51,40,51,41,1],[53,9,53,41,1],[54,9,54,43,1],[56,9,56,43,1],[58,9,58,53,1],[59,9,59,41,1],[60,5,60,6,1],[61,37,61,38,1],[62,9,62,22,1],[63,9,63,22,1],[64,9,64,24,1],[65,5,65,6,1],[67,77,67,78,1],[68,9,68,133,1],[69,9,69,25,1],[70,5,70,6,1],[73,36,73,37,1],[74,9,74,30,1],[75,9,75,69,1],[76,5,76,6,1],[77,44,77,45,1],[78,9,78,30,1],[78,31,78,32,1],[79,13,79,40,1],[82,9,82,33,1],[83,5,83,6,1],[85,86,85,87,1],[87,9,87,65,1],[89,9,89,41,1],[89,42,89,43,1],[90,13,90,20,1],[93,9,93,39,1],[95,9,95,16,1],[95,18,95,35,1],[95,36,95,38,1],[95,39,95,56,1],[95,58,95,59,1],[96,13,96,54,1],[97,9,97,10,1],[98,5,98,6,1],[100,69,100,70,1],[102,9,102,70,1],[104,9,104,44,1],[106,9,106,43,1],[106,44,106,45,1],[108,13,108,70,1],[109,13,109,47,1],[111,9,111,10,1],[111,16,111,53,1],[111,54,111,55,1],[113,13,113,70,1],[114,13,114,49,1],[116,9,116,10,1],[116,16,116,52,1],[116,53,116,54,1],[118,13,118,34,1],[119,13,119,47,1],[121,9,121,10,1],[121,16,121,52,1],[121,53,121,54,1],[123,13,123,34,1],[124,13,124,49,1],[125,9,125,10,1],[127,9,127,25,1],[128,5,128,6,1],[130,53,130,54,1],[132,9,132,47,1],[132,48,132,49,1],[133,13,133,25,1],[135,9,135,48,1],[135,49,135,50,1],[136,13,136,25,1],[139,9,139,44,1],[140,5,140,6,1],[142,47,142,48,1],[144,9,144,52,1],[146,9,146,63,1],[147,9,147,37,1],[148,9,148,40,1],[149,9,149,39,1],[150,9,150,39,1],[152,14,152,23,1],[152,25,152,30,1],[152,32,152,35,1],[152,37,152,38,1],[153,13,153,50,1],[154,13,154,38,1],[155,13,155,38,1],[156,9,156,10,1],[158,9,158,20,1],[159,5,159,6,1],[163,31,163,32,1],[164,9,164,27,1],[165,9,165,23,1],[166,9,166,21,1],[167,5,167,6,1],[169,36,169,37,1],[170,14,170,23,1],[170,25,170,34,1],[170,36,170,39,1],[170,41,170,42,1],[171,13,171,65,1],[172,9,172,10,1],[173,14,173,23,1],[173,25,173,35,1],[173,37,173,40,1],[173,42,173,43,1],[174,13,174,66,1],[175,9,175,10,1],[176,5,176,6,1],[178,32,178,33,1],[180,9,180,32,1],[181,9,181,33,1],[182,9,182,40,1],[183,9,183,41,1],[185,9,185,25,1],[186,9,186,35,1],[187,9,187,30,1],[188,9,188,30,1],[190,9,190,34,1],[191,9,191,39,1],[192,9,192,34,1],[193,9,193,39,1],[194,5,194,6,1],[195,42,195,43,1],[196,14,196,23,1],[196,25,196,30,1],[196,32,196,35,1],[196,37,196,38,1],[197,18,197,27,1],[197,29,197,34,1],[197,36,197,39,1],[197,41,197,42,1],[198,17,198,70,1],[199,13,199,14,1],[200,9,200,10,1],[201,5,201,6,1],[204,30,204,31,1],[206,14,206,23,1],[206,25,206,34,1],[206,36,206,39,1],[206,41,206,42,1],[208,13,208,45,1],[209,13,209,71,1],[210,13,210,23,1],[212,18,212,27,1],[212,29,212,39,1],[212,41,212,44,1],[212,46,212,47,1],[214,17,214,30,1],[214,31,214,32,1],[216,21,216,66,1],[218,21,218,25,1],[219,21,219,37,1],[219,38,219,39,1],[220,25,220,42,1],[221,21,221,22,1],[222,17,222,18,1],[222,24,222,70,1],[222,71,222,72,1],[223,21,223,66,1],[224,21,224,37,1],[225,17,225,18,1],[226,13,226,14,1],[227,9,227,10,1],[228,5,228,6,1],[232,34,232,35,1],[233,9,233,30,1],[234,9,234,33,1],[235,5,235,6,1],[237,39,237,40,1],[239,9,239,16,1],[239,18,239,46,1],[239,47,239,49,1],[239,50,239,55,1],[239,57,239,58,1],[241,13,241,91,1],[241,92,241,93,1],[242,17,242,79,1],[243,13,243,14,1],[244,13,244,93,1],[244,94,244,95,1],[245,17,245,82,1],[246,13,246,14,1],[247,9,247,10,1],[248,5,248,6,1],[250,42,250,43,1],[252,14,252,23,1],[252,25,252,34,1],[252,36,252,39,1],[252,41,252,42,1],[253,18,253,27,1],[253,29,253,39,1],[253,41,253,44,1],[253,46,253,47,1],[255,17,255,38,1],[257,17,257,141,1],[257,142,257,143,1],[259,21,259,98,1],[260,21,260,55,1],[262,21,262,148,1],[262,149,262,150,1],[263,25,263,68,1],[264,21,264,22,1],[265,17,265,18,1],[267,17,267,143,1],[267,144,267,145,1],[269,21,269,100,1],[270,21,270,55,1],[272,21,272,146,1],[272,147,272,148,1],[273,25,273,70,1],[274,21,274,22,1],[275,17,275,18,1],[276,13,276,14,1],[277,9,277,10,1],[278,5,278,6,1],[280,71,280,72,1],[282,9,282,22,1],[283,9,283,22,1],[284,9,284,48,1],[286,9,286,66,1],[288,9,288,66,1],[288,67,288,68,1],[289,13,289,20,1],[292,9,292,72,1],[293,9,293,81,1],[294,5,294,6,1],[295,88,295,89,1],[297,9,297,27,1],[299,17,299,21,1],[300,17,300,48,1],[301,17,301,23,1],[303,17,303,21,1],[304,17,304,48,1],[305,17,305,23,1],[307,17,307,21,0],[308,17,308,46,0],[309,17,309,23,0],[311,17,311,21,0],[312,17,312,49,0],[313,17,313,23,0],[315,17,315,21,1],[316,17,316,21,1],[317,17,317,52,1],[318,17,318,23,1],[320,17,320,21,1],[321,17,321,21,1],[322,17,322,50,1],[323,17,323,23,1],[325,17,325,21,0],[326,17,326,21,0],[327,17,327,51,0],[328,17,328,23,0],[330,17,330,21,0],[331,17,331,21,0],[332,17,332,53,0],[333,17,333,23,0],[335,5,335,6,1],[338,47,338,48,1],[339,9,339,33,1],[339,34,339,35,1],[340,13,340,26,1],[342,9,342,34,1],[342,35,342,36,1],[343,13,343,26,1],[346,9,346,21,1],[347,5,347,6,1]]);
    </script>
  </body>
</html>