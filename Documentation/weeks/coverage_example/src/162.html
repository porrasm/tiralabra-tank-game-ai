<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>p:\stuff\projects\minigamesproject\minigamesproject\assets\_assets\scripts\bearded man studios\scripts\networking\forge\networking\nat\natholepunch.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
/*-----------------------------+-------------------------------\
|                                                              |
|                         !!!NOTICE!!!                         |
|                                                              |
|  These libraries are under heavy development so they are     |
|  subject to make many changes as development continues.      |
|  For this reason, the libraries may not be well commented.   |
|  THANK YOU for supporting forge with all your feedback       |
|  suggestions, bug reports and comments!                      |
|                                                              |
|                              - The Forge Team                |
|                                Bearded Man Studios, Inc.     |
|                                                              |
|  This source code, project files, and associated files are   |
|  copyrighted by Bearded Man Studios, Inc. (2012-2017) and    |
|  may not be redistributed without written permission.        |
|                                                              |
\------------------------------+------------------------------*/

using BeardedManStudios.Forge.Networking.Frame;
using BeardedManStudios.SimpleJSON;

namespace BeardedManStudios.Forge.Networking.Nat
{
	public class NatHolePunch
	{
		/// &lt;summary&gt;
		/// This is the default server port for Forge Networking&#39;s NAT hole punch server
		/// &lt;/summary&gt;
		public const ushort DEFAULT_NAT_SERVER_PORT = 15941;

		/// &lt;summary&gt;
		/// An delegate that can be used to structure any kind of nat event
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;host&quot;&gt;The host address for the request&lt;/param&gt;
		/// &lt;param name=&quot;port&quot;&gt;The port number for the request&lt;/param&gt;
		public delegate void NatEvent(string host, ushort port);

		/// &lt;summary&gt;
		/// Occurs when a client is attempting to connect to a server
		/// &lt;/summary&gt;
		public event NatEvent clientConnectAttempt;

		/// &lt;summary&gt;
		/// The client that is used to connect to the remote NAT hole punch server
		/// &lt;/summary&gt;
		public UDPClient Client { get; private set; }

		/// &lt;summary&gt;
		/// Connect to the NAT hole punch server, this is called from a client machine
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;host&quot;&gt;The host address of the server the client is trying to connect to&lt;/param&gt;
		/// &lt;param name=&quot;port&quot;&gt;The port number of the server the client is trying to connect to&lt;/param&gt;
		/// &lt;param name=&quot;clientPort&quot;&gt;The port number that the client is listening on&lt;/param&gt;
		/// &lt;param name=&quot;natServer&quot;&gt;The NAT server host address to connect to&lt;/param&gt;
		/// &lt;param name=&quot;natPort&quot;&gt;The NAT server port number to connect to&lt;/param&gt;
		public void Connect(string host, ushort port, ushort clientPort, string natServer, ushort natPort = DEFAULT_NAT_SERVER_PORT)
		{
			// Don&#39;t allow multiple NAT server connection requests at once
			if (Client != null)
				return;

			// Connect to the NAT server
			Client = new UDPClient();
			Client.Connect(natServer, natPort, pendCreates: true);

			NetWorker.BaseNetworkEvent accepted = (NetWorker sender) =&gt;
			{
				// Send the data to the nat server with the host address and port that this client
				// is trying to connect to so that it can punch a hole in the network for this client
				JSONNode sendJson = JSONNode.Parse(&quot;{}&quot;);
				sendJson.Add(&quot;host&quot;, new JSONData(host));
				sendJson.Add(&quot;port&quot;, new JSONData(port));
				sendJson.Add(&quot;clientPort&quot;, new JSONData(clientPort));

				// Send the message to the NAT server
				Text connect = Text.CreateFromString(Client.Time.Timestep, sendJson.ToString(), false, Receivers.Server, MessageGroupIds.NAT_SERVER_CONNECT, false);
				Client.Send(connect, true);
				Client.messageConfirmed += (player, packet) =&gt; { if (packet.uniqueId == connect.UniqueId) { Client.Disconnect(false); } };
			};

			Client.serverAccepted += accepted;
		}

		/// &lt;summary&gt;
		/// Registers a server to the NAT server so that it can be requested to be joined by clients
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;currentPort&quot;&gt;The current port that this server is listening for client connections on&lt;/param&gt;
		/// &lt;param name=&quot;natServer&quot;&gt;The NAT server host address to connect to&lt;/param&gt;
		/// &lt;param name=&quot;natPort&quot;&gt;The NAT server port number to connect to&lt;/param&gt;
		public void Register(ushort currentPort, string natServer, ushort natPort = DEFAULT_NAT_SERVER_PORT)
		{
			// Don&#39;t allow multiple NAT server connection requests at once
			if (Client != null)
				return;

			// Connect to the NAT server
			Client = new UDPClient();
			Client.Connect(natServer, natPort, pendCreates: true);

			// When connected, request for this server to be registered to the NAT lookup for clients
			NetWorker.BaseNetworkEvent accepted = (NetWorker sender) =&gt;
			{
				JSONNode obj = JSONNode.Parse(&quot;{}&quot;);
				obj.Add(&quot;port&quot;, new JSONData(currentPort));

				JSONClass sendJson = new JSONClass();
				sendJson.Add(&quot;register&quot;, obj);

				// Send the message to the NAT server
				Text register = Text.CreateFromString(Client.Time.Timestep, sendJson.ToString(), false, Receivers.Target, MessageGroupIds.NAT_SERVER_REGISTER, false);
				Client.Send(register, true);
			};

			Client.serverAccepted += accepted;

			// Setup the callback events for when clients attempt to join
			Client.textMessageReceived += PlayerConnectRequestReceived;
		}

		/// &lt;summary&gt;
		/// The callback for when a player is trying to connect to this server from
		/// the NAT server
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;player&quot;&gt;The NAT server player&lt;/param&gt;
		/// &lt;param name=&quot;frame&quot;&gt;The data that the NAT server has sent for consumption&lt;/param&gt;
		private void PlayerConnectRequestReceived(NetworkingPlayer player, Text frame, NetWorker sender)
		{
			Logging.BMSLog.Log(&quot;PLAYER CONNECTION REQUEST&quot;);
			Logging.BMSLog.Log(frame.ToString());

			try
			{
				// This is a Text frame with JSON so parse it all
				var json = JSON.Parse(frame.ToString());

				// If this is a route from the NAT then read it
				if (json[&quot;nat&quot;] != null)
				{
					Logging.BMSLog.Log(&quot;DOING NAT&quot;);
					// These fields are required for this server to punch a hole for a client
					if (json[&quot;nat&quot;][&quot;host&quot;] != null &amp;&amp; json[&quot;nat&quot;][&quot;port&quot;] != null)
					{
						string host = json[&quot;nat&quot;][&quot;host&quot;];
						ushort port = json[&quot;nat&quot;][&quot;port&quot;].AsUShort;
						//Logging.BMSLog.Log($&quot;HOST IS {host} AND PORT IS {port}&quot;);

						// Fire the event that a client is trying to connect
						if (clientConnectAttempt != null)
							clientConnectAttempt(host, port);
					}
				}
			}
			catch { /* Ignore message */ }
		}

		public void Disconnect()
		{
			if (Client == null)
				return;

			Client.Disconnect(false);
		}
	}
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[47,29,47,33,0],[47,34,47,46,0],[58,3,58,4,0],[60,4,60,23,0],[61,5,61,12,0],[64,4,64,29,0],[65,4,65,58,0],[67,4,68,4,0],[68,4,68,5,0],[68,5,71,5,0],[71,5,71,46,0],[71,46,72,5,0],[72,5,72,46,0],[72,46,73,5,0],[73,5,73,46,0],[73,46,74,5,0],[74,5,74,58,0],[74,58,77,5,0],[77,5,77,153,0],[77,153,78,5,0],[78,5,78,32,0],[78,32,79,5,0],[79,5,79,52,0],[79,52,79,53,0],[79,53,79,54,0],[79,54,79,94,0],[79,94,79,95,0],[79,95,79,96,0],[79,96,79,97,0],[79,97,79,122,0],[79,122,79,123,0],[79,123,79,124,0],[79,124,79,125,0],[79,125,79,126,0],[79,126,79,127,0],[79,5,79,127,0],[79,127,80,4,0],[80,4,80,5,0],[80,5,80,6,0],[67,4,80,6,0],[82,4,82,38,0],[83,3,83,4,0],[92,3,92,4,0],[94,4,94,23,0],[95,5,95,12,0],[98,4,98,29,0],[99,4,99,58,0],[102,4,103,4,0],[103,4,103,5,0],[103,5,104,5,0],[104,5,104,41,0],[104,41,105,5,0],[105,5,105,48,0],[105,48,107,5,0],[107,5,107,42,0],[107,42,108,5,0],[108,5,108,35,0],[108,35,111,5,0],[111,5,111,155,0],[111,155,112,5,0],[112,5,112,33,0],[112,33,113,4,0],[113,4,113,5,0],[113,5,113,6,0],[102,4,113,6,0],[115,4,115,38,0],[118,4,118,63,0],[119,3,119,4,0],[128,3,128,4,0],[129,4,129,52,0],[130,4,130,41,0],[133,4,133,5,0],[135,5,135,45,0],[138,5,138,29,0],[139,5,139,6,0],[140,6,140,38,0],[142,6,142,69,0],[143,6,143,7,0],[144,7,144,41,0],[145,7,145,50,0],[149,7,149,40,0],[150,8,150,41,0],[151,6,151,7,0],[152,5,152,6,0],[153,4,153,5,0],[154,4,154,9,0],[154,10,154,11,0],[154,33,154,34,0],[155,3,155,4,0],[158,3,158,4,0],[159,4,159,23,0],[160,5,160,12,0],[162,4,162,29,0],[163,3,163,4,0]]);
    </script>
  </body>
</html>