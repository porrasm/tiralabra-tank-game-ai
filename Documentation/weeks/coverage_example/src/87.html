<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>p:\stuff\projects\minigamesproject\minigamesproject\assets\_assets\scripts\games\tankgame\tankcontrols.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using BeardedManStudios.Forge.Networking.Generated;
using System;
using System.Collections;
using System.Collections.Generic;
using UnityEngine;

public class TankControls : MonoBehaviour {

    #region fields
    private TankNetworking net;

    private Matrix4x4 calibrationMatrix;
    private Vector3 calibration;

    private bool testControls;

    public enum Control { Movement, Rotation, HeadRotation, Fire, Powerup }
    #endregion

    private void Start() {
        testControls = false;

        if (Player.MyPlayer().Local) {
            testControls = true;
        }

        net = GetComponent&lt;TankNetworking&gt;();

        calibrationMatrix = Matrix4x4.identity;
    }

    private void Update() {

        if (net.Owner == null || net.Owner.AI) {
            return;
        }

        ResetControls();

        if (Input.GetKeyDown(KeyCode.Alpha1)) {
            net.ChangeState(TankPlayer.PlayerState.Enabled);
        }

        if (Input.GetKeyDown(KeyCode.Space)) {
            testControls = !testControls;
        }

        if (net.State != TankPlayer.PlayerState.Enabled) {
            return;
        }

        PCTestControls();
    }
    private void PCTestControls() {

        if (!testControls) {
            return;
        }

        // PC CONTROLS FOR TESTING

        Vector2 movement = Vector2.zero;
        float rotation = 0;

        if (Input.GetKey(KeyCode.W)) {
            movement.y += 1;
        }
        if (Input.GetKey(KeyCode.S)) {
            movement.y -= 1;
        }
        if (Input.GetKey(KeyCode.D)) {
            movement.x += 1;
        }
        if (Input.GetKey(KeyCode.A)) {
            movement.x -= 1;
        }

        if (Input.GetKeyDown(KeyCode.Mouse0)) {
            net.Fire++;
        }
        if (Input.GetKeyDown(KeyCode.LeftShift)) {
            net.Powerup++;
        }

        net.Movement = movement;
        net.Rotation = rotation;
    }

    public void ResetControls() {
        net.Movement = Vector3.zero;
        net.Rotation = 0;
    }

    private void GyroControls() {

        if (testControls) {
            return;
        }

        Vector3 movement = FixOrientation(GetOrientation());

        net.Movement = new Vector2(movement.x, movement.z);
    }

    private Vector3 FixOrientation(Vector3 orientation) {

        orientation -= calibration;
        // orientation = Quaternion.Euler(Vector3.right) * orientation;

        return LimitVector(orientation);
    }
    private Vector3 LimitVector(Vector3 vector) {

        if (vector.x &gt; 1) {
            vector.x = 1;
        } else if (vector.x &lt; -1) {
            vector.x = -1;
        }

        if (vector.y &gt; 1) {
            vector.y = 1;
        } else if (vector.y &lt; -1) {
            vector.y = -1;
        }

        if (vector.z &gt; 1) {
            vector.z = 1;
        } else if (vector.z &lt; -1) {
            vector.z = -1;
        }

        return vector;
    }

    private Vector3 GetOrientation() {

        return Input.acceleration;

        Vector3 orientation = Vector3.zero;

        if (SystemInfo.supportsGyroscope) {
            orientation = GyroToUnity(Input.gyro.attitude).eulerAngles;
        } else if (SystemInfo.supportsAccelerometer) {
            orientation = Input.acceleration;
        } else {
            Debug.LogError(&quot;Neither gyro or accelerometer available&quot;);
        }

        return orientation;
    }
    private Quaternion GyroToUnity(Quaternion q) {
        print(&quot;GyroToUnity: &quot; + q);
        return new Quaternion(q.x, q.y, -q.z, -q.w);
    }

    public void CalibrateGyro() {
        StartCoroutine(CalibrateGyroCoroutine());
    }
    private IEnumerator CalibrateGyroCoroutine() {

        double x = 0;
        double y = 0;
        double z = 0;

        for (int i = 0; i &lt; 120; i++) {

            Vector3 orientation = GetOrientation();
            x += orientation.x;
            y += orientation.y;
            z += orientation.z;

            yield return null;
        }

        calibration = new Vector3((float)x / 120, (float)y / 120, (float)z / 120);

        print(&quot;Gyro rest: (&quot; + calibration.x + &quot;, &quot; + calibration.y + &quot;, &quot; + calibration.z + &quot;)&quot;);
    }

    #region Control Methods
    public void Fire() {
        net.Fire++;
    }

    public void Powerup() {
        net.Powerup++;
    }

    public void ProcessControl(Control control) {
        ProcessControl(control, 0);
    }
    public void ProcessControl(Control control, float value) {

        if (control == Control.Movement) {
            Vector2 movement = net.Movement;
            movement.y = value;
            net.Movement = movement;
        } else if (control == Control.Rotation) {
            Vector2 movement = net.Movement;
            movement.x = value;
            net.Movement = movement;
        } else if (control == Control.HeadRotation) {
            net.Rotation = value;
        } else if (control == Control.Fire) {
            Fire();
        } else if (control == Control.Powerup) {
            Powerup();
        }
    }
    #endregion
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[20,26,20,27,0],[21,9,21,30,0],[23,9,23,37,0],[23,38,23,39,0],[24,13,24,33,0],[25,9,25,10,0],[27,9,27,46,0],[29,9,29,48,0],[30,5,30,6,0],[32,27,32,28,0],[34,9,34,47,0],[34,48,34,49,0],[35,13,35,20,0],[38,9,38,25,0],[40,9,40,46,0],[40,47,40,48,0],[41,13,41,61,0],[42,9,42,10,0],[44,9,44,45,0],[44,46,44,47,0],[45,13,45,42,0],[46,9,46,10,0],[48,9,48,57,0],[48,58,48,59,0],[49,13,49,20,0],[52,9,52,26,0],[53,5,53,6,0],[54,35,54,36,0],[56,9,56,27,0],[56,28,56,29,0],[57,13,57,20,0],[62,9,62,41,0],[63,9,63,28,0],[65,9,65,37,0],[65,38,65,39,0],[66,13,66,29,0],[67,9,67,10,0],[68,9,68,37,0],[68,38,68,39,0],[69,13,69,29,0],[70,9,70,10,0],[71,9,71,37,0],[71,38,71,39,0],[72,13,72,29,0],[73,9,73,10,0],[74,9,74,37,0],[74,38,74,39,0],[75,13,75,29,0],[76,9,76,10,0],[78,9,78,46,0],[78,47,78,48,0],[79,13,79,24,0],[80,9,80,10,0],[81,9,81,49,0],[81,50,81,51,0],[82,13,82,27,0],[83,9,83,10,0],[85,9,85,33,0],[86,9,86,33,0],[87,5,87,6,0],[89,33,89,34,0],[90,9,90,37,0],[91,9,91,26,0],[92,5,92,6,0],[94,33,94,34,0],[96,9,96,26,0],[96,27,96,28,0],[97,13,97,20,0],[100,9,100,61,0],[102,9,102,60,0],[103,5,103,6,0],[105,57,105,58,0],[107,9,107,36,0],[110,9,110,41,0],[111,5,111,6,0],[112,49,112,50,0],[114,9,114,26,0],[114,27,114,28,0],[115,13,115,26,0],[116,9,116,10,0],[116,16,116,34,0],[116,35,116,36,0],[117,13,117,27,0],[118,9,118,10,0],[120,9,120,26,0],[120,27,120,28,0],[121,13,121,26,0],[122,9,122,10,0],[122,16,122,34,0],[122,35,122,36,0],[123,13,123,27,0],[124,9,124,10,0],[126,9,126,26,0],[126,27,126,28,0],[127,13,127,26,0],[128,9,128,10,0],[128,16,128,34,0],[128,35,128,36,0],[129,13,129,27,0],[130,9,130,10,0],[132,9,132,23,0],[133,5,133,6,0],[135,38,135,39,0],[137,9,137,35,0],[150,5,150,6,0],[151,50,151,51,0],[152,9,152,36,0],[153,9,153,53,0],[154,5,154,6,0],[156,33,156,34,0],[157,9,157,50,0],[158,5,158,6,0],[159,50,159,51,0],[161,9,161,22,0],[162,9,162,22,0],[163,9,163,22,0],[165,14,165,23,0],[165,25,165,32,0],[165,34,165,37,0],[165,39,165,40,0],[167,13,167,52,0],[168,13,168,32,0],[169,13,169,32,0],[170,13,170,32,0],[172,13,172,31,0],[173,9,173,10,0],[175,9,175,83,0],[177,9,177,99,0],[178,5,178,6,0],[181,24,181,25,0],[182,9,182,20,0],[183,5,183,6,0],[185,27,185,28,0],[186,9,186,23,0],[187,5,187,6,0],[189,49,189,50,0],[190,9,190,36,0],[191,5,191,6,0],[192,62,192,63,0],[194,9,194,41,0],[194,42,194,43,0],[195,13,195,45,0],[196,13,196,32,0],[197,13,197,37,0],[198,9,198,10,0],[198,16,198,48,0],[198,49,198,50,0],[199,13,199,45,0],[200,13,200,32,0],[201,13,201,37,0],[202,9,202,10,0],[202,16,202,52,0],[202,53,202,54,0],[203,13,203,34,0],[204,9,204,10,0],[204,16,204,44,0],[204,45,204,46,0],[205,13,205,20,0],[206,9,206,10,0],[206,16,206,47,0],[206,48,206,49,0],[207,13,207,23,0],[208,9,208,10,0],[209,5,209,6,0]]);
    </script>
  </body>
</html>