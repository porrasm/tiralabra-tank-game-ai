<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>p:\stuff\projects\minigamesproject\minigamesproject\assets\_assets\scripts\games\tankgame\tanklevelgenerator.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections;
using System.Collections.Generic;
using System.Diagnostics;
using UnityEngine;

// Most things breaks if width != height, fix later :):)
public class TankLevelGenerator : MonoBehaviour {

    #region fields
    private TankMazeGenerator generator;
    private List&lt;Step&gt; steps;
    private TankCell[,] cells;
    private Vector2 area;

    private int width;
    private int height;

    [SerializeField]
    private GameObject cellPrefab;

    [SerializeField]
    private Transform cellParent, levelFloor;

    private Transform levelParent;

    public bool Building { get; set; }

    private byte[,] level;

    public byte[,] Level { get =&gt; level; private set =&gt; level = value; }

    public struct Step {
        public IntCoords Coords;
        public TankCell.CellWall Wall;
        public bool Silent;
        public override string ToString() {
            return Wall + &quot; &quot; + Coords;
        }
    }

    #endregion

    #region Basic
    private void Awake() {

        if (Instance == null) {
            Instance = this;
        } else {
            UnityEngine.Debug.LogError(&quot;Instance is already set.&quot;);
            Destroy(this);
        }

        generator = new TankMazeGenerator();
    }
    private void Start() {   
        levelParent = GameObject.FindGameObjectWithTag(&quot;Level&quot;).transform;
    }
    private void Update() {
        if (Input.GetKeyDown(KeyCode.R)) {
            GenerateLevel();
            BuildGeneratedLevel();
        }
    }

    public void GenerateLevel() {
        generator.GenerateMaze(out steps, out level);
    }
    public void BuildGeneratedLevel() {

        if (Building) {
            return;
        }

        Initialize();

        Building = true;

        BuildLevel();
    }

    #endregion

    #region Initialization
    private void Initialize() {
        ClearLevel();
        InitializeVariables();
        InitializeLevel();
    }

    private void InitializeVariables() {

        width = TankSettings.LevelWidth;
        height = TankSettings.LevelHeight;

        cells = new TankCell[width, height];
    }
    private void ClearLevel() {
        foreach (Transform child in cellParent) {
            Destroy(child.gameObject);
        }
    }

    private void InitializeLevel() {
        InitializeLevelArea();
        InitializeCamera();
        SetSpawns();
        CreateCells();
    }

    private void InitializeLevelArea() {
        levelFloor.localScale = new Vector3(0.1f * height, 1, 0.1f * width);
        levelFloor.position = new Vector3(0.5f * width, levelFloor.position.y, 0.5f * height);
    }
    private void InitializeCamera() {

        Vector3 position = new Vector3(1.0f * height / 2, 10, 1.0f * width / 2);
        float size;

        if (height &gt; width) {
            size = position.x * TankSettings.CameraSizeFactorX;
        } else {
            size = position.z * TankSettings.CameraSizeFactorY;
        }

        Camera.main.transform.position = position;
        Camera.main.orthographicSize = size;
    }

    private void SetSpawns() {

        Transform spawns = GameObject.FindGameObjectWithTag(&quot;Respawn&quot;).transform;

        for (int i = 0; i &lt; spawns.childCount; i++) {
            spawns.GetChild(i).position = SpawnPosition(i);
            spawns.GetChild(i).LookAt(new Vector3(0.5f * width, 0, 0.5f * height));
        }
    }
    private Vector3 SpawnPosition(int index) {

        float offset = 0.5f;

        switch (index) {
            case 0:
                return new Vector3(offset, 0, offset);
            case 1:
                return new Vector3(width - offset, 0, height - offset);
            case 2:
                return new Vector3(offset, 0, height - offset);
            case 3:
                return new Vector3(width - offset, 0, offset);
            case 4:
                return new Vector3(offset * width, 0, offset);
            case 5:
                return new Vector3(offset * width, 0, height - offset);
            case 6:
                return new Vector3(width - offset, 0, offset * height);
            case 7:
                return new Vector3(offset, 0, offset * height);
        }

        return Vector3.zero;
    }

    private void CreateCells() {
        for (int x = 0; x &lt; width; x++) {
            for (int y = 0; y &lt; height; y++) {
                CreateCell(x, y);
            }
        }
    }
    private void CreateCell(int x, int y) {

        GameObject newCell = Instantiate(cellPrefab);

        newCell.name = &quot;Cell (&quot; + x + &quot;, &quot; + y + &quot; )&quot;;

        cells[x, y] = newCell.GetComponent&lt;TankCell&gt;();
        cells[x, y].SetWalls(TankSettings.StartActive);

        Transform t = newCell.transform;

        t.SetParent(cellParent);
        t.localScale = new Vector3(1, 1, 1);
        t.localPosition = CellPosition(x, y);
    }
    private Vector3 CellPosition(int x, int y) {
        return new Vector3(x, 0, y);
    }
    #endregion
   
    #region Building
    private void BuildLevel() {
        StartCoroutine(BuildCoroutine());
    }
    private IEnumerator BuildCoroutine() {

        float waitTime = TankSettings.GenerateTime / steps.Count;

        Stopwatch watch = new Stopwatch();

        float additional = 0;

        foreach (Step step in steps) {

            if (ProcessStep(step)) {
                continue;
            }

            if (waitTime == 0) {
                continue;
            } else if (waitTime + additional &lt; Time.deltaTime) {
                additional += Time.deltaTime;
                continue;
            }

            yield return new WaitForSeconds(waitTime + additional);
            additional = 0;
        }

        Building = false;
    }
    private bool ProcessStep(Step step) {

        TankCell cell = cells[step.Coords.x, step.Coords.y];

        if (cell == null) {
            return true;
        }

        cell.SetWalls(true);
        cell.DisableWall(step.Wall);

        return step.Silent;
    }
    #endregion

    public static TankLevelGenerator Instance { get; private set; }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[27,28,27,32,0],[27,33,27,37,0],[31,35,31,40,0],[31,57,31,70,0],[37,43,37,44,0],[38,13,38,40,0],[39,9,39,10,0],[45,26,45,27,0],[47,9,47,30,0],[47,31,47,32,0],[48,13,48,29,0],[49,9,49,10,0],[49,16,49,17,0],[50,13,50,68,0],[51,13,51,27,0],[52,9,52,10,0],[54,9,54,45,0],[55,5,55,6,0],[56,26,56,27,0],[57,9,57,75,0],[58,5,58,6,0],[59,27,59,28,0],[60,9,60,41,0],[60,42,60,43,0],[61,13,61,29,0],[62,13,62,35,0],[63,9,63,10,0],[64,5,64,6,0],[66,33,66,34,0],[67,9,67,54,0],[68,5,68,6,0],[69,39,69,40,0],[71,9,71,22,0],[71,23,71,24,0],[72,13,72,20,0],[75,9,75,22,0],[77,9,77,25,0],[79,9,79,22,0],[80,5,80,6,0],[85,31,85,32,0],[86,9,86,22,0],[87,9,87,31,0],[88,9,88,27,0],[89,5,89,6,0],[91,40,91,41,0],[93,9,93,41,0],[94,9,94,43,0],[96,9,96,45,0],[97,5,97,6,0],[98,31,98,32,0],[99,9,99,16,0],[99,18,99,33,0],[99,34,99,36,0],[99,37,99,47,0],[99,49,99,50,0],[100,13,100,39,0],[101,9,101,10,0],[102,5,102,6,0],[104,36,104,37,0],[105,9,105,31,0],[106,9,106,28,0],[107,9,107,21,0],[108,9,108,23,0],[109,5,109,6,0],[111,40,111,41,0],[112,9,112,77,0],[113,9,113,95,0],[114,5,114,6,0],[115,37,115,38,0],[117,9,117,81,0],[120,9,120,28,0],[120,29,120,30,0],[121,13,121,64,0],[122,9,122,10,0],[122,16,122,17,0],[123,13,123,64,0],[124,9,124,10,0],[126,9,126,51,0],[127,9,127,45,0],[128,5,128,6,0],[130,30,130,31,0],[132,9,132,82,0],[134,14,134,23,0],[134,25,134,46,0],[134,48,134,51,0],[134,53,134,54,0],[135,13,135,60,0],[136,13,136,84,0],[137,9,137,10,0],[138,5,138,6,0],[139,46,139,47,0],[141,9,141,29,0],[143,9,143,23,0],[145,17,145,55,0],[147,17,147,72,0],[149,17,149,64,0],[151,17,151,63,0],[153,17,153,63,0],[155,17,155,72,0],[157,17,157,72,0],[159,17,159,64,0],[162,9,162,29,0],[163,5,163,6,0],[165,32,165,33,0],[166,14,166,23,0],[166,25,166,34,0],[166,36,166,39,0],[166,41,166,42,0],[167,18,167,27,0],[167,29,167,39,0],[167,41,167,44,0],[167,46,167,47,0],[168,17,168,34,0],[169,13,169,14,0],[170,9,170,10,0],[171,5,171,6,0],[172,43,172,44,0],[174,9,174,54,0],[176,9,176,55,0],[178,9,178,56,0],[179,9,179,56,0],[181,9,181,41,0],[183,9,183,33,0],[184,9,184,45,0],[185,9,185,46,0],[186,5,186,6,0],[187,48,187,49,0],[188,9,188,37,0],[189,5,189,6,0],[193,31,193,32,0],[194,9,194,42,0],[195,5,195,6,0],[196,42,196,43,0],[198,9,198,66,0],[200,9,200,43,0],[202,9,202,30,0],[204,9,204,16,0],[204,18,204,27,0],[204,28,204,30,0],[204,31,204,36,0],[204,38,204,39,0],[206,13,206,35,0],[206,36,206,37,0],[207,17,207,26,0],[210,13,210,31,0],[210,32,210,33,0],[211,17,211,26,0],[212,20,212,63,0],[212,64,212,65,0],[213,17,213,46,0],[214,17,214,26,0],[217,13,217,68,0],[218,13,218,28,0],[219,9,219,10,0],[221,9,221,26,0],[222,5,222,6,0],[223,41,223,42,0],[225,9,225,61,0],[227,9,227,26,0],[227,27,227,28,0],[228,13,228,25,0],[231,9,231,29,0],[232,9,232,37,0],[234,9,234,28,0],[235,5,235,6,0],[238,49,238,53,0],[238,54,238,66,0]]);
    </script>
  </body>
</html>