<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>p:\stuff\projects\minigamesproject\minigamesproject\assets\_assets\scripts\games\tankgame\tankweapon.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System.Collections;
using System.Collections.Generic;
using UnityEngine;

public class TankWeapon : MonoBehaviour {


    #region fields
    private Transform bulletSpawn;
    private TankPlayer player;

    [SerializeField]
    private GameObject bulletPrefab;

    private TankPowerup powerup;
    public void NullifyPowerup() {
        powerup = null;
    }

    private int clip;
    private bool reloading;
    private bool fireWait;
    private float fireDelay;

    private float reloadTime;
    #endregion


    private void Start() {
        bulletSpawn = transform.GetChild(0).GetChild(2).GetChild(0);

        player = GetComponent&lt;TankPlayer&gt;();

        fireDelay = 1.0f / TankSettings.FireRate;

        Reload();

        powerup = TankPowerup.GivePowerup(TankPowerup.Type.Shield, gameObject);
    }

    private int fireIndex;
    private int powerupIndex;

    public void Fire(int index) {
        if (index &gt; fireIndex) {
            if (!BlockFire()) {
                if (!fireWait) {
                    fireIndex = index;
                    FirePrefab();
                }
            } else {
                fireIndex = index;
            }
        }
    }
    private bool BlockFire() {
        if (clip &lt; 1) {
            return true;
        }
        if (powerup == null) {
            return false;
        }

        if (powerup.BehaviourType == TankPowerup.Behaviour.OverrideFire) {
            Powerup(powerupIndex + 1);
            return false;
        }

        return powerup.BehaviourType == TankPowerup.Behaviour.BlockFire;
    }

    private GameObject FirePrefab() {
        return FirePrefab(bulletPrefab);
    }
    public GameObject FirePrefab(GameObject bulletPrefab) {

        clip--;

        Reload();
        WaitFire();

        GameObject newBullet = Instantiate(bulletPrefab);
        newBullet.transform.position = bulletSpawn.position;
        newBullet.transform.forward = bulletSpawn.forward;
        newBullet.GetComponent&lt;TankBullet&gt;().Owner = player;

        return newBullet;
    }

    private void WaitFire() {

        if (fireWait) {
            return;
        }

        IEnumerator WaitCoroutine() {
            float time = fireDelay;

            while (time &gt; 0) {
                time -= Time.deltaTime;
                yield return null;
            }

            fireWait = false;
        }

        fireWait = true;
        StartCoroutine(WaitCoroutine());
    }

    public void Reload() {

        if (reloading &amp;&amp; clip &gt; 0) {
            reloadTime = TankSettings.ReloadTime;
            return;
        } else if (reloading &amp;&amp; clip == 0) {
            return;
        }

        IEnumerator ReloadCoroutine() {

            reloadTime = TankSettings.ReloadTime;

            while (reloadTime &gt; 0) {
                reloadTime -= Time.deltaTime;
                yield return null;
            }

            reloading = false;

            clip = TankSettings.ClipAmount;
        }

        reloading = true;

        StartCoroutine(ReloadCoroutine());
    }

    public void Powerup(int index) {
        if (index &gt; powerupIndex) {
            powerupIndex = index;

            if (powerup != null) {
                powerup.Use();
            }
        }
    }

    public void Set() {

        TankNetworking net = GetComponent&lt;TankNetworking&gt;();

        fireIndex = net.Fire;
        powerupIndex = net.Powerup;
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[16,34,16,35,0],[17,9,17,24,0],[18,5,18,6,0],[29,26,29,27,0],[30,9,30,69,0],[32,9,32,45,0],[34,9,34,50,0],[36,9,36,18,0],[38,9,38,80,0],[39,5,39,6,0],[44,33,44,34,0],[45,9,45,31,0],[45,32,45,33,0],[46,13,46,30,0],[46,31,46,32,0],[47,17,47,31,0],[47,32,47,33,0],[48,21,48,39,0],[49,21,49,34,0],[50,17,50,18,0],[51,13,51,14,0],[51,20,51,21,0],[52,17,52,35,0],[53,13,53,14,0],[54,9,54,10,0],[55,5,55,6,0],[56,30,56,31,0],[57,9,57,22,0],[57,23,57,24,0],[58,13,58,25,0],[60,9,60,29,0],[60,30,60,31,0],[61,13,61,26,0],[64,9,64,73,0],[64,74,64,75,0],[65,13,65,39,0],[66,13,66,26,0],[69,9,69,73,0],[70,5,70,6,0],[72,37,72,38,0],[73,9,73,41,0],[74,5,74,6,0],[75,59,75,60,0],[77,9,77,16,0],[79,9,79,18,0],[80,9,80,20,0],[82,9,82,58,0],[83,9,83,61,0],[84,9,84,59,0],[85,9,85,61,0],[87,9,87,26,0],[88,5,88,6,0],[90,29,90,30,0],[92,9,92,22,0],[92,23,92,24,0],[93,13,93,20,0],[96,37,96,38,0],[97,13,97,36,0],[99,13,99,29,0],[99,30,99,31,0],[100,17,100,40,0],[101,17,101,35,0],[102,13,102,14,0],[104,13,104,30,0],[105,9,105,10,0],[107,9,107,25,0],[108,9,108,41,0],[109,5,109,6,0],[111,26,111,27,0],[113,9,113,35,0],[113,36,113,37,0],[114,13,114,50,0],[115,13,115,20,0],[116,16,116,43,0],[116,44,116,45,0],[117,13,117,20,0],[120,39,120,40,0],[122,13,122,50,0],[124,13,124,35,0],[124,36,124,37,0],[125,17,125,46,0],[126,17,126,35,0],[127,13,127,14,0],[129,13,129,31,0],[131,13,131,44,0],[132,9,132,10,0],[134,9,134,26,0],[136,9,136,43,0],[137,5,137,6,0],[139,36,139,37,0],[140,9,140,34,0],[140,35,140,36,0],[141,13,141,34,0],[143,13,143,33,0],[143,34,143,35,0],[144,17,144,31,0],[145,13,145,14,0],[146,9,146,10,0],[147,5,147,6,0],[149,23,149,24,0],[151,9,151,61,0],[153,9,153,30,0],[154,9,154,36,0],[155,5,155,6,0]]);
    </script>
  </body>
</html>