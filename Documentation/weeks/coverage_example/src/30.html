<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>p:\stuff\projects\minigamesproject\minigamesproject\assets\_assets\scripts\games\tankgame\powerups\tankpowerup_missile.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System.Collections;
using System.Collections.Generic;
using UnityEngine;

public class TankPowerup_Missile : TankPowerup {

    private Transform crosshair, target;
    private TankNetworking targetPlayer;
    private float rotateSpeed = 100;
    private bool used;
    private bool locked;

    private float initTime = 1;
    private float time, targetTime;

    void Update() {
        MoveCrosshair();
    }

    public override void Use() {
        base.Use();

        IEnumerator UseCoroutine() {

            used = true;

            InitializeCrosshair();

            yield return new WaitForSeconds(initTime);

            SeekPlayer();

            yield return new WaitForSeconds(time);

            print(&quot;Locked player&quot;);

            yield return new WaitUntil(CrosshairOnTarget);

            locked = true;

            print(&quot;locked&quot;);

            ShootLaser();
        }

        StartCoroutine(UseCoroutine());
    }

    private void InitializeCrosshair() {

        crosshair = Instantiate(TankGameHost.Game().PowerupCrosshairObject).transform;
        float pos = 0.5f * TankSettings.LevelWidth;
        crosshair.position = new Vector3(pos, 1, pos);

        float time = 0;
        float factor = 0.01f;

        Light light = crosshair.GetChild(0).GetComponent&lt;Light&gt;();

        IEnumerator InitCoroutine() {       

            while (time &lt; initTime) {

                time += Time.deltaTime;

                factor = time / initTime;

                if (factor &gt; 1) {
                    factor = 1;
                }

                crosshair.localScale = Vector3.one * factor;
                light.intensity = factor * 0.5f;

                yield return null;
            }

            crosshair.localScale = Vector3.one;
            light.intensity = 0.5f;
        }

        StartCoroutine(InitCoroutine());
    }

    private void SeekPlayer() {

        target = RandomPlayer();

        time = TankSettings.P_MissileTime * 0.75f + TankSettings.P_MissileTime * 0.5f;
        targetTime = RandomTargetTime();

        IEnumerator SeekCoroutine() {

            while (time &gt; 0) {

                time -= Time.deltaTime;
                targetTime -= Time.deltaTime;

                if (targetTime &lt;= 0) {
                    targetTime = RandomTargetTime();
                    target = RandomPlayer();
                }

                yield return null;
            }
        }

        StartCoroutine(SeekCoroutine());
    }

    private void ShootLaser() {

        target.GetComponent&lt;TankPlayer&gt;().Invulnerable = false;

        IEnumerator CrosshairLock() {

            float scaleBig = 0.25f;
            float scaleSmall = -0.5f;

            float time = 0;
            float scaleFactor = 1 / time;

            while (time &lt; 0.25f) {

                time += Time.deltaTime;

                float factor = time / 0.25f;

                crosshair.localScale = Vector3.one * (1 + factor * scaleBig);
                yield return null;
            }

            rotateSpeed *= 4;

            time = 0;
            while (time &lt; 0.33f) {

                time += Time.deltaTime;

                float factor = time / 0.33f;

                crosshair.localScale = Vector3.one * (1 + scaleBig + factor * scaleSmall);
                yield return null;
            }
        }

        StartCoroutine(CrosshairLock());
    }

    private Transform RandomPlayer() {

        print(&quot;Switch missile target&quot;);

        GameObject[] tanks = GameObject.FindGameObjectsWithTag(&quot;Player&quot;);

        List&lt;GameObject&gt; alive = new List&lt;GameObject&gt;();

        foreach (GameObject g in tanks) {
            if (g.GetComponent&lt;TankNetworking&gt;().State == TankPlayer.PlayerState.Enabled) {
                alive.Add(g);
            }
        }

        GameObject p = alive[Random.Range(0, alive.Count - 1)];
        targetPlayer = p.GetComponent&lt;TankNetworking&gt;();
        return p.transform;
    }
    private float RandomTargetTime() {
        return 0.25f + Random.value * (TankSettings.P_MissileTargetChangeMax - 0.25f);
    }

    private void MoveCrosshair() {

        if (!used) {
            return;
        }

        crosshair.Rotate(Vector3.up * rotateSpeed * Time.deltaTime);
        crosshair.position += TranslateDirection();
    }

    private Vector3 TranslateDirection() {

        if (target == null) {
            return Vector3.zero;
        }

        float distance = XZDistance();

        Vector3 direction = (target.position - crosshair.position);
        direction.y = 0;

        direction = direction.normalized * TankSettings.P_MissileSpeed * Time.deltaTime;

        if (direction.magnitude &gt; distance) {
            direction = direction.normalized * distance;
        }

        return direction;
    }
    private bool CrosshairOnTarget() {

        if (targetPlayer.State != TankPlayer.PlayerState.Enabled) {
            print(&quot;Target not alive&quot;);
            target = RandomPlayer();
        }

        return XZDistance() &lt; 0.2f;
    }
    private float XZDistance() {

        Vector3 ch = crosshair.position;

        ch.y = target.position.y;

        return Vector3.Distance(target.position, ch);
    }

    public override void Remove() {

        StopAllCoroutines();

        Destroy(crosshair.gameObject);

        base.Remove();
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[9,5,9,37,0],[13,5,13,32,0],[16,19,16,20,0],[17,9,17,25,0],[18,5,18,6,0],[20,32,20,33,0],[21,9,21,20,0],[23,36,23,37,0],[25,13,25,25,0],[27,13,27,35,0],[29,13,29,55,0],[31,13,31,26,0],[33,13,33,51,0],[35,13,35,36,0],[37,13,37,59,0],[39,13,39,27,0],[41,13,41,29,0],[43,13,43,26,0],[44,9,44,10,0],[46,9,46,40,0],[47,5,47,6,0],[49,40,49,41,0],[51,9,51,87,0],[52,9,52,52,0],[53,9,53,55,0],[55,9,55,24,0],[56,9,56,30,0],[58,9,58,67,0],[60,37,60,38,0],[62,13,62,36,0],[62,37,62,38,0],[64,17,64,40,0],[66,17,66,42,0],[68,17,68,32,0],[68,33,68,34,0],[69,21,69,32,0],[70,17,70,18,0],[72,17,72,61,0],[73,17,73,49,0],[75,17,75,35,0],[76,13,76,14,0],[78,13,78,48,0],[79,13,79,36,0],[80,9,80,10,0],[82,9,82,41,0],[83,5,83,6,0],[85,31,85,32,0],[87,9,87,33,0],[89,9,89,87,0],[90,9,90,41,0],[92,37,92,38,0],[94,13,94,29,0],[94,30,94,31,0],[96,17,96,40,0],[97,17,97,46,0],[99,17,99,37,0],[99,38,99,39,0],[100,21,100,53,0],[101,21,101,45,0],[102,17,102,18,0],[104,17,104,35,0],[105,13,105,14,0],[106,9,106,10,0],[108,9,108,41,0],[109,5,109,6,0],[111,31,111,32,0],[113,9,113,64,0],[115,37,115,38,0],[117,13,117,36,0],[118,13,118,38,0],[120,13,120,28,0],[121,13,121,42,0],[123,13,123,33,0],[123,34,123,35,0],[125,17,125,40,0],[127,17,127,45,0],[129,17,129,78,0],[130,17,130,35,0],[131,13,131,14,0],[133,13,133,30,0],[135,13,135,22,0],[136,13,136,33,0],[136,34,136,35,0],[138,17,138,40,0],[140,17,140,45,0],[142,17,142,91,0],[143,17,143,35,0],[144,13,144,14,0],[145,9,145,10,0],[147,9,147,41,0],[148,5,148,6,0],[150,38,150,39,0],[152,9,152,40,0],[154,9,154,74,0],[156,9,156,57,0],[158,9,158,16,0],[158,18,158,30,0],[158,31,158,33,0],[158,34,158,39,0],[158,41,158,42,0],[159,13,159,90,0],[159,91,159,92,0],[160,17,160,30,0],[161,13,161,14,0],[162,9,162,10,0],[164,9,164,64,0],[165,9,165,57,0],[166,9,166,28,0],[167,5,167,6,0],[168,38,168,39,0],[169,9,169,87,0],[170,5,170,6,0],[172,34,172,35,0],[174,9,174,19,0],[174,20,174,21,0],[175,13,175,20,0],[178,9,178,69,0],[179,9,179,52,0],[180,5,180,6,0],[182,42,182,43,0],[184,9,184,28,0],[184,29,184,30,0],[185,13,185,33,0],[188,9,188,39,0],[190,9,190,68,0],[191,9,191,25,0],[193,9,193,89,0],[195,9,195,44,0],[195,45,195,46,0],[196,13,196,57,0],[197,9,197,10,0],[199,9,199,26,0],[200,5,200,6,0],[201,38,201,39,0],[203,9,203,66,0],[203,67,203,68,0],[204,13,204,39,0],[205,13,205,37,0],[206,9,206,10,0],[208,9,208,36,0],[209,5,209,6,0],[210,32,210,33,0],[212,9,212,41,0],[214,9,214,34,0],[216,9,216,54,0],[217,5,217,6,0],[219,35,219,36,0],[221,9,221,29,0],[223,9,223,39,0],[225,9,225,23,0],[226,5,226,6,0]]);
    </script>
  </body>
</html>